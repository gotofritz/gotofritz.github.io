
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Manipulating XML iTunes library files with Ruby - Fabrizio (Fritz) Stelluto</title>
	<meta name="author" content="">

	
	<meta name="description" content="The challenge this week: shell script(s) to quickly edit the iTunes library and copy files around. About the challenge iTunes is quite limiting in &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Fabrizio (Fritz) Stelluto" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
	<link rel="icon" href="/favicon.gif" type="image/gif" />
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	
</head>


<body ontouchstart="">

  <header id="header" class="inner">
<nav id="main-nav"><div>
  <a class="rss" href="/atom.xml" title="RSS">RSS</a>
  <a href="/">home</a>
  <a href="/blog/">blog</a>
</div></nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><div>
  <a class="rss" href="/atom.xml" title="RSS">RSS</a>
  <a href="/">home</a>
  <a href="/blog/">blog</a>
</div></div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:gotofritz.net">
			</form>
		</div>
	</div>
</nav>

<nav id="sub-nav" class="alignright">
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:gotofritz.net">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner">
    
    <article class="post">
	<h1 class="title">Manipulating XML iTunes Library Files With Ruby</h1>
	<div>
		<div class="meta">
			<div class="date">








  


<time datetime="2012-07-15T13:04:15+02:00" pubdate data-updated="true">2012-07-15, Sun</time></div>
			<div class="tags">


	<a class='category' href='/blog/cat/weekly-challenge/'>Weekly Challenge</a>


</div>
			
				<span class="comments"><a href="/blog/weekly-challenge/manipulating-xml-itunes-library-ruby#disqus_thread">Comments</a></span>
			
		</div>
		<div class="entry-content"><p>The challenge this week: shell script(s) to quickly edit the iTunes library and copy files around.</p>

<!--more-->


<h2>About the challenge</h2>

<p>iTunes is quite limiting in what it does and doesn&#8217;t allow people to do with their own music. There are a number of things which are not easy to do: copying files from a playlists into a USB stick for car journeys, identifying missing files, removing files from the hard disk which are no longer in the iTunes library, and so on.</p>

<p>One can write AppleScript utilities for those types of tasks - check out <a href="http://dougscripts.com/itunes/">Doug&#8217;s AppleScripts for iTunes</a> for example - but I try to avoid AppleScript at all costs if I can.</p>

<p>Luckily, iTunes keeps an XML copy of the library data (a <a href="http://en.wikipedia.org/wiki/Property_list">plist</a>), one I can manipulate in any language of my choice. Since I have been wanting to play with Ruby for years, I decided to make this my first script. Because the file can get quite huge, an event based parser like SAX should be used, whether it&#8217;s pull or push (here&#8217;s <a href="http://www.programmersheaven.com/user/pawanspace/blog/609-XML-parsers-Push-versus-Pull-parsers/">a quick article explaining the difference between push and pull parsers</a>).</p>

<p>Some artefacts <a href="https://github.com/gotofritz/Weekly-Challenges/tree/master/weekly-challenge-23_ruby-itunes-fiddler">available on GitHub</a>.</p>

<h2>Generating an XML iTunes library file with Ruby</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='gherkin'><span class='line'><span class="k">Feature:</span><span class="nf"> Generating an XML iTunes library file with Ruby</span>
</span><span class='line'><span class="nf">  In order to manipulate the iTunes library</span>
</span><span class='line'><span class="nf">  As a command line user</span>
</span><span class='line'><span class="nf">  I need to be able to read it and generate a manipulated version</span>
</span></code></pre></td></tr></table></div></figure>


<p>Initially I need to find a good XML parser, and prove that I can read the library file and process it into another library file that is still valid.</p>

<h3>Running a simple Ruby script from the command line</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='gherkin'><span class='line'><span class="k">Scenario:</span><span class="nf"> Running a simple Ruby script from the command line</span>
</span><span class='line'><span class="k">    Given </span><span class="nf">that I am in the folder &quot;</span><span class="s">weekly-challenge-23_ruby-itunes-fiddler</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">    </span><span class="k">When </span><span class="nf">I run the command itunefiddler</span>
</span><span class='line'><span class="nf">    </span><span class="k">Then </span><span class="nf">the script should run</span>
</span><span class='line'><span class="nf">    </span><span class="k">And </span><span class="nf">the last line of output should start with &quot;</span><span class="s">done</span><span class="nf">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Babysteps, as this is my very first ruby script. This can all be done quickly on the command line:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>touch itunesfiddler
</span><span class='line'><span class="nb">echo</span> <span class="s1">&#39;#!/usr/bin/env ruby&#39;</span> &gt;&gt; itunesfiddler
</span><span class='line'><span class="nb">echo</span> <span class="s1">&#39;&#39;</span> &gt;&gt; itunesfiddler
</span><span class='line'><span class="nb">echo</span> <span class="s1">&#39;puts &quot;done&quot;&#39;</span> &gt;&gt; itunesfiddler
</span><span class='line'>chmod 775 itunesfiddler
</span><span class='line'>./itunesfiddler
</span><span class='line'>subl itunesfiddler
</span></code></pre></td></tr></table></div></figure>


<p>The lines starting with touch and echo create the files and add a line at the time to it. Then I make it executable, run it, and open it in Sublime Text 2 for further editing.</p>

<h3>Duplicating the XML library file in Ruby</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='gherkin'><span class='line'><span class="k">Scenario:</span><span class="nf"> Duplicating the XML library file in Ruby</span>
</span><span class='line'><span class="k">  Given </span><span class="nf">that I have a library XML file called iTunes Music Library.xml</span>
</span><span class='line'><span class="nf">  </span><span class="k">And </span><span class="nf">an executable ruby script called itunefiddler</span>
</span><span class='line'><span class="nf">  </span><span class="k">When </span><span class="nf">I run the command itunefiddler</span>
</span><span class='line'><span class="nf">  </span><span class="k">And </span><span class="nf">I pass --input &quot;</span><span class="s">iTunes Music Library.xml</span><span class="nf">&quot; as an argument</span>
</span><span class='line'><span class="nf">  </span><span class="k">And </span><span class="nf">I pass --output &quot;</span><span class="s">iTunes_library_new.xml</span><span class="nf">&quot; as an argument</span>
</span><span class='line'><span class="nf">  </span><span class="k">Then </span><span class="nf">&quot;</span><span class="s">iTunes_library_new.xml</span><span class="nf">&quot; should be created</span>
</span><span class='line'><span class="nf">  </span><span class="k">And </span><span class="nf">it should be a copy of &quot;</span><span class="s">iTunes_library.xml</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">  </span><span class="k">And </span><span class="nf">the output should be &quot;</span><span class="s">done - iTunes_library_new.xml</span><span class="nf">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This scenario covers passing command line arguments, and opening files for reading and writing.</p>

<p>I started using ARGV to read arguments, but that is nowhere near flexible enough.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># =itunesfiddler</span>
</span><span class='line'><span class="c1"># parses an XML library file for iTunes into another</span>
</span><span class='line'><span class="no">ARGV</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span><span class="o">|</span><span class="n">a</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Argument: </span><span class="si">#{</span><span class="n">a</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">a</span>
</span><span class='line'>  <span class="k">when</span> <span class="sr">/--input=(\w+)/</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;INPUT: </span><span class="si">#{</span><span class="vg">$1</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;done&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ugly regex alert! I used the OptionParser module in the end.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># =itunesfiddler</span>
</span><span class='line'><span class="c1"># parses an XML library file for iTunes into another</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;optparse&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#reads command line args</span>
</span><span class='line'><span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'><span class="n">itunesfiddler</span> <span class="o">=</span> <span class="no">OptionParser</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">opt</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#help screen</span>
</span><span class='line'>  <span class="n">opt</span><span class="o">.</span><span class="n">banner</span> <span class="o">=</span> <span class="s2">&quot;Usage: itunesfiddler --input=FILE [OPTIONS] [COMMAND]&quot;</span>
</span><span class='line'>  <span class="n">opt</span><span class="o">.</span><span class="n">separator</span>  <span class="s2">&quot;&quot;</span>
</span><span class='line'>  <span class="n">opt</span><span class="o">.</span><span class="n">separator</span>  <span class="s2">&quot;Commands&quot;</span>
</span><span class='line'>  <span class="n">opt</span><span class="o">.</span><span class="n">separator</span>  <span class="s2">&quot;&quot;</span>
</span><span class='line'>  <span class="n">opt</span><span class="o">.</span><span class="n">separator</span>  <span class="s2">&quot;Options&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#individual options</span>
</span><span class='line'>  <span class="n">opt</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;-i&quot;</span><span class="p">,</span><span class="s2">&quot;--input SRC&quot;</span><span class="p">,</span><span class="s2">&quot;input xml file&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">src</span><span class="o">|</span>
</span><span class='line'>    <span class="k">unless</span> <span class="no">File</span><span class="o">.</span><span class="n">file?</span> <span class="n">src</span>
</span><span class='line'>      <span class="nb">abort</span><span class="p">(</span> <span class="s2">&quot;File not found </span><span class="si">#{</span><span class="n">src</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">options</span><span class="o">[</span><span class="ss">:src</span><span class="o">]</span> <span class="o">=</span> <span class="n">src</span>
</span><span class='line'>    <span class="k">unless</span> <span class="n">options</span><span class="o">[</span><span class="ss">:target</span><span class="o">]</span>
</span><span class='line'>      <span class="n">options</span><span class="o">[</span><span class="ss">:target</span><span class="o">]</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:src</span><span class="o">].</span><span class="n">clone</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;.new&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">opt</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;-o&quot;</span><span class="p">,</span><span class="s2">&quot;--output [TARGET]&quot;</span><span class="p">,</span><span class="s2">&quot;output xml file&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">target</span><span class="o">|</span>
</span><span class='line'>    <span class="n">options</span><span class="o">[</span><span class="ss">:target</span><span class="o">]</span> <span class="o">=</span> <span class="n">target</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">opt</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;-h&quot;</span><span class="p">,</span><span class="s2">&quot;--help&quot;</span><span class="p">,</span><span class="s2">&quot;help&quot;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="n">itunesfiddler</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#collects args and quits if something wrong</span>
</span><span class='line'><span class="n">itunesfiddler</span><span class="o">.</span><span class="n">parse!</span>
</span><span class='line'><span class="k">unless</span> <span class="n">options</span><span class="o">[</span><span class="ss">:src</span><span class="o">]</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="n">itunesfiddler</span>
</span><span class='line'>  <span class="nb">abort</span><span class="p">(</span> <span class="s2">&quot;ERROR: missing --input&quot;</span> <span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As for reading and writing the file, it&#8217;s all very simple in Ruby.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#copies file over</span>
</span><span class='line'><span class="nb">open</span><span class="p">(</span> <span class="n">options</span><span class="o">[</span><span class="ss">:target</span><span class="o">]</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span> <span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">open</span><span class="p">(</span> <span class="n">options</span><span class="o">[</span><span class="ss">:src</span><span class="o">]</span> <span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
</span><span class='line'>    <span class="n">f</span> <span class="o">&lt;&lt;</span> <span class="n">x</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;done </span><span class="si">#{</span><span class="n">options</span><span class="o">[</span><span class="ss">:target</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="nb">exit</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>I have added a couple of nice to haves - the &#8211;input= parameter is mandatory, the &#8211;output= param is derived from input if not passed.</p>

<p>To test it, first of all I moved iTunes Library.itl and iTunes Music Library.xml out of the Music/iTunes folder, which means next time iTunes is started it will run with a blank library. Started iTunes, and a new version of iTunes Music Library.xml was created automatically. I took that file as the starting point for my work - the real library is too big.</p>

<p>I copied this default XML file to the weekly-challenge-23_ruby-itunes-fiddler folder, and manually added some tracks - I copied the XML fragment from the original libray. It&#8217;s all quite straight forward. I also added a track I knew wasn&#8217;t there.</p>

<p>To test my hand editing was done properly, I imported the edited XML file with: File > Library  > Import Playlist&#8230;  It did what I expected, i.e. imported the songs I had added manually, as well as complaining about the missing track.</p>

<p>I then quit iTunes and deleted the library files again again. This time I used my script to duplicate the edited XML file</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./itunesfiddler --input <span class="s2">&quot;iTunes Music Library.xml&quot;</span> --output <span class="s2">&quot;iTunes_library_new.xml&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p> It created a duplicate called iTunes_library_new.xml. I imported that into iTunes, and it worked just like the hand coded original.</p>

<p>So far so good - but no XML parsing yet.</p>

<h2>Using an event based parser to duplicate an XML file</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='gherkin'><span class='line'><span class="k">Feature:</span><span class="nf"> Using an event based parser to duplicate an XML file</span>
</span><span class='line'><span class="nf">  In order to understand the XML data in the iTunes library</span>
</span><span class='line'><span class="nf">  As a command line user</span>
</span><span class='line'><span class="nf">  I want to duplicate it using a SAX parser</span>
</span></code></pre></td></tr></table></div></figure>


<p>No new functionality is introduced, this is just refactoring to use a SAX parser. I picked the <a href="http://nokogiri.org/Nokogiri/XML/SAX.html">Nokogiri SAX Parser</a>, which is easily installed as a gem</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo gem install nokogiri
</span></code></pre></td></tr></table></div></figure>


<p>In the code, I subclassed the SAX::Document class to set up all the callbacks, passing a filehandle so that it can write XML out there and then. I could have stored the XML to a temp object and returned that at the end, but I didn&#8217;t want to keep a 200MB string in memory.</p>

<h3>What is SAX parsing</h3>

<p>If you are not familiar with SAX, the idea is very simple. The parser reads the input file one character at the time, and whenever it detects a point where a node changes, it generates a corresponding event. For example, when it sees a > after a &lt;TAG_NAME it generates the event &#8220;node start&#8221; (or suchlike), and passes &#8220;TAG_NAME&#8221; and an array of attributes, to the event call. It then moves on to the next character, forgetting everything about TAG_NAME. It&#8217;s this forgetting that make SAX parsers useful - because they only remember enough to detect when tags are open or closed, they don&#8217;t clog the memory.</p>

<p>The way to use a SAX parser is to set up callbacks for each of those events emitted as the parser reads the document. Sounds laborious, but in reality there isn&#8217;t that much going on in an XML document as you can see from the <a href="http://nokogiri.org/Nokogiri/XML/SAX/Document.html">list of Nokogiri SAX events</a> - a new tag is found, a tag is finished, a CDATA is found, etc.</p>

<p>The lack of memory is both the strength and the weakness of SAX parsers. Because they have no concept of the data structure they are parsing, it is very hard, for example, to move a node to another parent. Even recognizing where you are at any given time is quite laborious, particularly if you use the same node name at different depths - which is what plists do. SAX parsers are typically used to convert XML data to another format, or extract some nodes from a large list, or do some simple node manipulation.</p>

<p>At this stage however, I am keeping track of nothing, I am just duplicating the file to prove it works.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#collection of callbacks for SAX parser</span>
</span><span class='line'><span class="k">class</span> <span class="nc">ITunesLibraryCallbacks</span> <span class="o">&lt;</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">XML</span><span class="o">::</span><span class="no">SAX</span><span class="o">::</span><span class="no">Document</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">filehandle</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">=</span> <span class="n">filehandle</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">characters</span> <span class="n">str</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="n">str</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">start_element</span> <span class="n">element_name</span><span class="p">,</span> <span class="n">attributes</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">element_name</span>
</span><span class='line'>    <span class="k">when</span> <span class="s2">&quot;plist&quot;</span>
</span><span class='line'>      <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;&lt;plist version=&quot;1.0&quot;&gt;&#39;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;&lt;</span><span class="si">#{</span><span class="n">element_name</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">end_element</span> <span class="n">element_name</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;&lt;/</span><span class="si">#{</span><span class="n">element_name</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">error</span> <span class="n">error_message</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s2">&quot;ERROR: </span><span class="si">#{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I only need to worry about three callbacks because plists have a very basic structure - they have no comments, CDATA, or attributes except the root node, which can be hardcoded. Therefore only three callbacks are needed: opening tag, closing tag, and characters (i.e., what&#8217;s inside a tag).</p>

<p>Then I changed the block that copies the file over. In theory the SAX parser could open its own filehandle and write the whole thing itself, but this particular parser doesn&#8217;t generate an event for DOCTYPE nodes. Therefore I open a filehandle outside the parser, copy the first two lines of the input files manually, then pass on the filehandle to the parser and let it do its job. Not great, but not the end of the world either.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#copies file over</span>
</span><span class='line'><span class="nb">open</span><span class="p">(</span> <span class="n">options</span><span class="o">[</span><span class="ss">:target</span><span class="o">]</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span> <span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">open</span><span class="p">(</span> <span class="n">options</span><span class="o">[</span><span class="ss">:src</span><span class="o">]</span> <span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
</span><span class='line'>    <span class="n">f</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">.</span><span class="n">readline</span> <span class="c1">#the xml declaration - could be handled by parser but...</span>
</span><span class='line'>    <span class="n">f</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">.</span><span class="n">readline</span> <span class="c1">#the doctype - this one cannot be handled by the parser</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">parser</span> <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">XML</span><span class="o">::</span><span class="no">SAX</span><span class="o">::</span><span class="no">Parser</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="no">ITunesLibraryCallbacks</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="n">f</span> <span class="p">)</span> <span class="p">)</span>
</span><span class='line'>  <span class="n">parser</span><span class="o">.</span><span class="n">parse_file</span><span class="p">(</span> <span class="n">options</span><span class="o">[</span><span class="ss">:src</span><span class="o">]</span> <span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I run it and tested as I did earlier, and iTunes seems happy importing it.</p>

<h3>Extracting track records with SAX parsing</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='gherkin'><span class='line'><span class="k">Scenario:</span><span class="nf"> Extracting track records with SAX parsing</span>
</span><span class='line'><span class="k">    Given </span><span class="nf">that the script is parsing the XML iTunes file</span>
</span><span class='line'><span class="nf">    </span><span class="k">When </span><span class="nf">it encounters the start of a track block</span>
</span><span class='line'><span class="nf">    </span><span class="k">Then </span><span class="nf">it should hold off producing output until it gets all the related tags</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now the &#8220;fun&#8221; with SAX parsing can start. To make the whole thing useful, it is important the script can abstract a group of tags into a &#8216;track&#8217;. Because SAX has no memory, I need to keep track of what is being parsed. A common trick is to use a breadcrumb.</p>

<p>First of all, I put the ITunesLibraryCallbacks class into its own file, and included it using</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#collection of callbacks for SAX parser</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;ITunesLibraryCallbacks&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#copies file over</span>
</span><span class='line'><span class="nb">open</span><span class="p">(</span> <span class="n">options</span><span class="o">[</span><span class="ss">:target</span><span class="o">]</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span> <span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">open</span><span class="p">(</span> <span class="n">options</span><span class="o">[</span><span class="ss">:src</span><span class="o">]</span> <span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
</span><span class='line'>    <span class="n">f</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">.</span><span class="n">readline</span> <span class="c1">#the xml declaration - could be handled by parser but...</span>
</span><span class='line'>    <span class="n">f</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">.</span><span class="n">readline</span> <span class="c1">#the doctype - this one cannot be handled by the parser</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="vg">$iTLCInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryCallbacks</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="n">f</span> <span class="p">)</span>
</span><span class='line'>  <span class="n">parser</span> <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">XML</span><span class="o">::</span><span class="no">SAX</span><span class="o">::</span><span class="no">Parser</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vg">$iTLCInstance</span> <span class="p">)</span>
</span><span class='line'>  <span class="n">parser</span><span class="o">.</span><span class="n">parse_file</span><span class="p">(</span> <span class="n">options</span><span class="o">[</span><span class="ss">:src</span><span class="o">]</span> <span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;done - </span><span class="si">#{</span><span class="vg">$iTLCInstance</span><span class="o">.</span><span class="n">track_count</span><span class="si">}</span><span class="s2"> tracks, created:</span><span class="si">#{</span><span class="n">options</span><span class="o">[</span><span class="ss">:target</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="nb">exit</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>I made the instance global, $iTLCInstance, so that I can query its get_count method later.</p>

<p>ITunesLibraryCallbacks will now stop writing output when a new track is found, collect all the track data in an object, and only write it out in one go when the end track in the input is found. Potentially, at that stage further processing is possible (e.g., don&#8217;t add the track in if the song file doesn&#8217;t exist, etc).</p>

<p>The code is a bit ugly, but that&#8217;s partly how SAX parsing goes, and partly this being my first Ruby script.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ITunesLibraryCallbacks</span> <span class="o">&lt;</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">XML</span><span class="o">::</span><span class="no">SAX</span><span class="o">::</span><span class="no">Document</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:breadcrumb</span><span class="p">,</span> <span class="ss">:track_count</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">filehandle</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@track_count</span>  <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="vi">@separator</span>    <span class="o">=</span> <span class="s2">&quot;/&quot;</span>
</span><span class='line'>    <span class="vi">@breadcrumb</span>   <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="vi">@mode</span>         <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="vi">@filehandle</span>   <span class="o">=</span> <span class="n">filehandle</span>
</span><span class='line'>    <span class="vi">@is_tracks</span>    <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>    <span class="vi">@is_playlists</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>    <span class="vi">@track</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="vi">@element_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="vi">@track_attr</span>
</span><span class='line'>    <span class="vi">@node_separator</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">       &quot;</span>
</span><span class='line'>    <span class="vi">@track_separator</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">characters</span> <span class="n">str</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">str</span>
</span><span class='line'>    <span class="k">when</span> <span class="s2">&quot;Tracks&quot;</span>
</span><span class='line'>      <span class="vi">@is_tracks</span>    <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>      <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="n">str</span>
</span><span class='line'>    <span class="k">when</span> <span class="s2">&quot;Playlists&quot;</span>
</span><span class='line'>      <span class="vi">@is_playlists</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>      <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="n">str</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">is_track_start</span>
</span><span class='line'>        <span class="vi">@track</span><span class="o">[</span><span class="ss">:key</span><span class="o">]</span> <span class="o">=</span> <span class="n">str</span>
</span><span class='line'>        <span class="vi">@track</span><span class="o">[</span><span class="ss">:dict</span><span class="o">]</span> <span class="o">=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>      <span class="k">elsif</span> <span class="n">is_track_key</span>
</span><span class='line'>        <span class="vi">@track_attr</span><span class="o">[</span><span class="ss">:key</span><span class="o">]</span> <span class="o">=</span> <span class="n">str</span>
</span><span class='line'>      <span class="k">elsif</span> <span class="n">is_track_value</span>
</span><span class='line'>        <span class="vi">@track_attr</span><span class="o">[</span><span class="ss">:value</span><span class="o">]</span> <span class="o">=</span> <span class="n">str</span>
</span><span class='line'>      <span class="k">elsif</span> <span class="o">!</span><span class="vi">@is_tracks</span>
</span><span class='line'>        <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="n">str</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">start_element</span> <span class="n">element_name</span><span class="p">,</span> <span class="n">attributes</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="n">breadcrumb_add</span><span class="p">(</span> <span class="n">element_name</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@element_name</span> <span class="o">=</span> <span class="n">element_name</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">element_name</span>
</span><span class='line'>    <span class="k">when</span> <span class="s2">&quot;plist&quot;</span>
</span><span class='line'>      <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;&lt;plist version=&quot;1.0&quot;&gt;&#39;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">is_top_level_key</span>
</span><span class='line'>        <span class="vi">@is_tracks</span>    <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>        <span class="vi">@is_playlists</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>        <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;&lt;</span><span class="si">#{</span><span class="n">element_name</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
</span><span class='line'>      <span class="k">elsif</span> <span class="n">is_track_start</span>
</span><span class='line'>        <span class="vi">@track</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>        <span class="vi">@track_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>      <span class="k">elsif</span> <span class="n">is_track_key</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span> <span class="kp">nil</span> <span class="o">!=</span> <span class="vi">@track_attr</span> <span class="p">)</span>
</span><span class='line'>          <span class="vi">@track</span><span class="o">[</span><span class="ss">:dict</span><span class="o">].</span><span class="n">push</span><span class="p">(</span> <span class="vi">@track_attr</span> <span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="vi">@track_attr</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>      <span class="k">elsif</span> <span class="n">is_track_value</span>
</span><span class='line'>        <span class="vi">@track_attr</span><span class="o">[</span><span class="ss">:type</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@element_name</span>
</span><span class='line'>      <span class="k">elsif</span> <span class="o">!</span><span class="vi">@is_tracks</span> <span class="o">||</span> <span class="n">is_tracks_container</span>
</span><span class='line'>        <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;&lt;</span><span class="si">#{</span><span class="n">element_name</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">end_element</span> <span class="n">element_name</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">is_track_end</span>
</span><span class='line'>      <span class="n">track_print</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="o">!</span><span class="vi">@is_tracks</span> <span class="o">||</span> <span class="n">is_tracks_container</span>
</span><span class='line'>      <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;&lt;/</span><span class="si">#{</span><span class="n">element_name</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">breadcrumb_remove</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">breadcrumb_add</span> <span class="n">element_name</span>
</span><span class='line'>    <span class="vi">@breadcrumb</span> <span class="o">=</span> <span class="vi">@breadcrumb</span> <span class="o">+</span> <span class="vi">@separator</span> <span class="o">+</span> <span class="n">element_name</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">breadcrumb_remove</span>
</span><span class='line'>    <span class="n">temp</span> <span class="o">=</span> <span class="vi">@breadcrumb</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="vi">@separator</span> <span class="p">)</span>
</span><span class='line'>    <span class="n">temp</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span class='line'>    <span class="vi">@element_name</span> <span class="o">=</span> <span class="n">temp</span><span class="o">[-</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@breadcrumb</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="vi">@separator</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">track_print</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="vi">@track_separator</span> <span class="o">+</span> <span class="s2">&quot;&lt;key&gt;</span><span class="si">#{</span><span class="vi">@track</span><span class="o">[</span><span class="ss">:key</span><span class="o">]</span><span class="si">}</span><span class="s2">&lt;/key&gt;&quot;</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="vi">@track_separator</span> <span class="o">+</span> <span class="s2">&quot;&lt;dict&gt;&quot;</span>
</span><span class='line'>    <span class="vi">@track</span><span class="o">[</span><span class="ss">:dict</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span> <span class="o">=</span> <span class="n">row</span><span class="o">[</span><span class="ss">:type</span><span class="o">]</span>
</span><span class='line'>      <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="vi">@node_separator</span> <span class="o">+</span> <span class="s2">&quot;&lt;key&gt;</span><span class="si">#{</span><span class="n">row</span><span class="o">[</span><span class="ss">:key</span><span class="o">]</span><span class="si">}</span><span class="s2">&lt;/key&gt;&quot;</span> <span class="o">+</span> <span class="s2">&quot;&lt;</span><span class="si">#{</span><span class="n">t</span><span class="si">}</span><span class="s2">&gt;</span><span class="si">#{</span><span class="n">row</span><span class="o">[</span><span class="ss">:value</span><span class="o">]</span><span class="si">}</span><span class="s2">&lt;/</span><span class="si">#{</span><span class="n">t</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="vi">@track_separator</span> <span class="o">+</span> <span class="s2">&quot;&lt;/dict&gt;&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_track_start</span>
</span><span class='line'>    <span class="k">return</span> <span class="vi">@is_tracks</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;/plist/dict/dict/key&quot;</span> <span class="o">==</span> <span class="vi">@breadcrumb</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_top_level_key</span>
</span><span class='line'>    <span class="k">return</span> <span class="s2">&quot;/plist/dict/key&quot;</span> <span class="o">==</span> <span class="vi">@breadcrumb</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_track_key</span>
</span><span class='line'>    <span class="k">return</span> <span class="vi">@is_tracks</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;/plist/dict/dict/dict/key&quot;</span> <span class="o">==</span> <span class="vi">@breadcrumb</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_track_value</span>
</span><span class='line'>    <span class="k">return</span> <span class="vi">@is_tracks</span> <span class="o">&amp;&amp;</span> <span class="o">[</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/dict/dict/integer&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/dict/dict/string&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/dict/dict/true&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/dict/dict/false&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/dict/dict/date&#39;</span>
</span><span class='line'>      <span class="o">].</span><span class="n">any?</span> <span class="p">{</span> <span class="o">|</span><span class="n">bc</span><span class="o">|</span>
</span><span class='line'>        <span class="vi">@breadcrumb</span> <span class="o">===</span> <span class="n">bc</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_tracks_container</span>
</span><span class='line'>    <span class="k">return</span> <span class="vi">@is_tracks</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s1">&#39;/plist/dict/dict&#39;</span><span class="p">,</span> <span class="s1">&#39;/plist/dict/key&#39;</span> <span class="o">].</span><span class="n">any?</span> <span class="p">{</span> <span class="o">|</span><span class="n">bc</span><span class="o">|</span>
</span><span class='line'>      <span class="vi">@breadcrumb</span> <span class="o">===</span> <span class="n">bc</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_track_end</span>
</span><span class='line'>    <span class="k">return</span> <span class="vi">@is_tracks</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;/plist/dict/dict/dict&quot;</span> <span class="o">==</span> <span class="vi">@breadcrumb</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">error</span> <span class="n">error_message</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s2">&quot;ERROR: </span><span class="si">#{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As before I run it on a reduced file and imported the result into iTunes, and it worked. I also benchmarked it against the real iTunes library, a 150MB file with 3M lines and 80k tracks, and it run in 2m47.366s - which is much better than I thought it would be.</p>

<h3>Unit Testing and Mocking a SAX Parser with Ruby</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='gherkin'><span class='line'><span class="k">Scenario:</span><span class="nf"> Unit Testing and MOcking a SAX parser with Ruby</span>
</span><span class='line'><span class="k">    Given </span><span class="nf">that I have a ITunesLibraryCallbacks</span>
</span><span class='line'><span class="nf">    </span><span class="k">When </span><span class="nf">I run unit tests on it</span>
</span><span class='line'><span class="nf">    </span><span class="k">Then </span><span class="nf">they should pass</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that I got something useful, it&#8217;s time to bring unit testing and TDD into the picture, so that I can improve it more easily as my Ruby improves.</p>

<p>I created a file test-ITunesLibraryCallbacks.tb</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;ITunesLibraryCallbacks&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;test/unit&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ITunesLibraryCallbacksTest</span> <span class="o">&lt;</span> <span class="no">Test</span><span class="o">::</span><span class="no">Unit</span><span class="o">::</span><span class="no">TestCase</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryCallbacks</span><span class="o">.</span><span class="n">new</span><span class="p">({})</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">terdown</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_breadcrumb_add</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">breadcrumb_add</span> <span class="s2">&quot;test&quot;</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s1">&#39;/test&#39;</span><span class="p">,</span> <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">breadcrumb</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then run it simply with</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ruby -rtest/unit -e0 -- --pattern <span class="s1">&#39;test-&#39;</span>
</span><span class='line'>Loaded suite .
</span><span class='line'>Started
</span><span class='line'>.
</span><span class='line'>Finished in 0.000193 seconds.
</span><span class='line'>
</span><span class='line'>1 tests, 1 assertions, 0 failures, 0 errors
</span></code></pre></td></tr></table></div></figure>


<p>Blimey, that was easy.</p>

<p>The next step is to mock the writing to file. I did that with FlexMock:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo gem install flexmock
</span></code></pre></td></tr></table></div></figure>


<p>I wrote a simple test to make sure the mocking works,</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ITunesLibraryCallbacksTest</span> <span class="o">&lt;</span> <span class="no">Test</span><span class="o">::</span><span class="no">Unit</span><span class="o">::</span><span class="no">TestCase</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">=</span> <span class="n">flexmock</span><span class="p">()</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_breadcrumb_add</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryCallbacks</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">breadcrumb_add</span> <span class="s2">&quot;test&quot;</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s1">&#39;/test&#39;</span><span class="p">,</span> <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">breadcrumb</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_character_add</span>
</span><span class='line'>    <span class="n">chars</span> <span class="o">=</span> <span class="s2">&quot;this_should_be_written&quot;</span>
</span><span class='line'>    <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="n">chars</span> <span class="p">)</span><span class="o">.</span><span class="n">once</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryCallbacks</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">characters</span> <span class="n">chars</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And it does.</p>

<h3>Refactoring into a library parser, and a library callback class</h3>

<p>Now that I got started on unit testing, it&#8217;s time for the first round of refactoring. The main objective here is to split the two main responsibilities of the class into separate classes. ITunesLibraryCallbacks will concentrate on parsing the input XML and understanding when a track or a plalyist starts or end. It will then generate its own SAX-like events, such as &#8220;track start&#8221; or &#8220;playlist end&#8221;, and pass data with them.</p>

<p>A new class, ITunesLibraryWriter, will respond to these events. The initial implementation will simply output an exact copy of the original XML file (give or take - for example it prints <true></true> instead of <true/>). The idea is that when special processing is needed, one overwrites some of the method calls as needed.</p>

<p>The events I added for now are: tracks_collection_start, tracks_collection_end, playlists_collection_start, playlists_collection_end, top_level_start, library_start, track_end, playlist_end, top_level_row, top_level_end, library_end. Here&#8217;s the code for all of them.</p>

<p>The script itunesfiddler hasn&#8217;t changed.</p>

<p>ITunesLibraryCallbacks has been changed a lot. It takes an ITunesLibraryWriter instance as optional second argument, or will create a vanilla one if none passed.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># =ITunesLibraryCallbacks</span>
</span><span class='line'><span class="c1"># SAX callbacks for iTunes library parsing</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;nokogiri&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;ITunesLibraryWriter&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ITunesLibraryCallbacks</span> <span class="o">&lt;</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">XML</span><span class="o">::</span><span class="no">SAX</span><span class="o">::</span><span class="no">Document</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:breadcrumb</span><span class="p">,</span> <span class="ss">:track_count</span><span class="p">,</span> <span class="ss">:is_tracks</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#takes a filehandler as argument</span>
</span><span class='line'>  <span class="c1">#optionally an instance of a subclass of ITunesLibraryWriter</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span> <span class="o">*</span><span class="n">args</span> <span class="p">)</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">args</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>    <span class="k">when</span> <span class="mi">1</span>
</span><span class='line'>      <span class="vi">@filehandle</span>   <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>      <span class="vi">@library_callbacks</span> <span class="o">=</span> <span class="no">ITunesLibraryWriter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="p">)</span>
</span><span class='line'>    <span class="k">when</span> <span class="mi">2</span>
</span><span class='line'>      <span class="vi">@filehandle</span><span class="p">,</span> <span class="vi">@library_callbacks</span> <span class="o">=</span> <span class="n">args</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">&quot;This class takes either 1 or 2 arguments.&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@track_count</span>  <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="vi">@playlist</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="vi">@separator</span>    <span class="o">=</span> <span class="s2">&quot;/&quot;</span>
</span><span class='line'>    <span class="vi">@breadcrumb</span>   <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="vi">@top_level_key</span>    <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="vi">@last_key</span>    <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="vi">@track</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="vi">@element_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="vi">@property_row</span>
</span><span class='line'>    <span class="vi">@node_separator</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">       &quot;</span>
</span><span class='line'>    <span class="vi">@track_separator</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#standard callback</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">characters</span> <span class="n">str</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">is_top_level_key</span>
</span><span class='line'>      <span class="vi">@top_level_key</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="n">clone</span><span class="o">.</span><span class="n">downcase!</span>
</span><span class='line'>      <span class="vi">@property_row</span><span class="o">[</span><span class="ss">:key</span><span class="o">]</span> <span class="o">=</span> <span class="n">str</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_track_value</span>
</span><span class='line'>      <span class="vi">@property_row</span><span class="o">[</span><span class="ss">:value</span><span class="o">]</span> <span class="o">=</span> <span class="n">str</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_track_key</span>
</span><span class='line'>      <span class="vi">@property_row</span><span class="o">[</span><span class="ss">:key</span><span class="o">]</span> <span class="o">=</span> <span class="n">str</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_playlist_items_value</span>
</span><span class='line'>      <span class="vi">@playlist</span><span class="o">[</span><span class="ss">:items</span><span class="o">].</span><span class="n">push</span><span class="p">(</span> <span class="p">{</span> <span class="ss">:key</span> <span class="o">=&gt;</span> <span class="s2">&quot;Track ID&quot;</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="ss">:value</span> <span class="o">=&gt;</span> <span class="n">str</span> <span class="p">}</span> <span class="p">)</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_playlist_value</span>
</span><span class='line'>      <span class="vi">@property_row</span><span class="o">[</span><span class="ss">:value</span><span class="o">]</span> <span class="o">=</span> <span class="n">str</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_playlist_key</span>
</span><span class='line'>      <span class="vi">@property_row</span><span class="o">[</span><span class="ss">:key</span><span class="o">]</span> <span class="o">=</span> <span class="n">str</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_top_level_value</span>
</span><span class='line'>      <span class="vi">@property_row</span><span class="o">[</span><span class="ss">:value</span><span class="o">]</span> <span class="o">=</span> <span class="n">str</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_track_start</span>
</span><span class='line'>      <span class="vi">@track</span><span class="o">[</span><span class="ss">:key</span><span class="o">]</span> <span class="o">=</span> <span class="n">str</span>
</span><span class='line'>      <span class="vi">@track</span><span class="o">[</span><span class="ss">:dict</span><span class="o">]</span> <span class="o">=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="s2">&quot;key&quot;</span> <span class="o">==</span> <span class="vi">@element_name</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>      <span class="p">(</span> <span class="mi">5</span> <span class="o">==</span> <span class="n">depth</span> <span class="p">)</span>
</span><span class='line'>      <span class="vi">@last_key</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="n">clone</span><span class="o">.</span><span class="n">downcase!</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#standard callback</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">start_element</span> <span class="n">element_name</span><span class="p">,</span> <span class="n">attributes</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="n">breadcrumb_add</span><span class="p">(</span> <span class="n">element_name</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@element_name</span> <span class="o">=</span> <span class="n">element_name</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">is_track_start</span>
</span><span class='line'>      <span class="vi">@track</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>      <span class="vi">@track_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_track_key</span>
</span><span class='line'>      <span class="vi">@property_row</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_track_value</span>
</span><span class='line'>      <span class="vi">@property_row</span><span class="o">[</span><span class="ss">:type</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@element_name</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_playlist_items_key</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_playlist_key</span>
</span><span class='line'>      <span class="vi">@property_row</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_playlist_value</span>
</span><span class='line'>      <span class="vi">@property_row</span><span class="o">[</span><span class="ss">:type</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@element_name</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_playlist_start</span>
</span><span class='line'>      <span class="vi">@playlist</span><span class="o">[</span><span class="ss">:dict</span><span class="o">]</span> <span class="o">=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_top_level_value</span>
</span><span class='line'>      <span class="vi">@property_row</span><span class="o">[</span><span class="ss">:type</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@element_name</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_tracks_collection_start</span>
</span><span class='line'>      <span class="vi">@property_row</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>      <span class="vi">@library_callbacks</span><span class="o">.</span><span class="n">tracks_collection_start</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_playlists_collection_start</span>
</span><span class='line'>      <span class="vi">@property_row</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>      <span class="vi">@library_callbacks</span><span class="o">.</span><span class="n">playlists_collection_start</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_top_level_key</span>
</span><span class='line'>      <span class="vi">@is_tracks</span>    <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>      <span class="vi">@is_playlists</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>      <span class="vi">@property_row</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_top_level</span>
</span><span class='line'>      <span class="vi">@library_callbacks</span><span class="o">.</span><span class="n">top_level_start</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">element_name</span> <span class="o">==</span> <span class="s2">&quot;plist&quot;</span>
</span><span class='line'>      <span class="vi">@library_callbacks</span><span class="o">.</span><span class="n">library_start</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#standard callback</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">end_element</span> <span class="n">element_name</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">is_track_end</span>
</span><span class='line'>      <span class="vi">@library_callbacks</span><span class="o">.</span><span class="n">track_end</span> <span class="vi">@track</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_track_key</span>
</span><span class='line'>      <span class="vi">@track</span><span class="o">[</span><span class="ss">:dict</span><span class="o">].</span><span class="n">push</span><span class="p">(</span> <span class="vi">@property_row</span> <span class="p">)</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_playlist_items_start</span>
</span><span class='line'>      <span class="vi">@playlist</span><span class="o">[</span><span class="ss">:items</span><span class="o">]</span> <span class="o">=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_playlist_key</span>
</span><span class='line'>      <span class="vi">@playlist</span><span class="o">[</span><span class="ss">:dict</span><span class="o">].</span><span class="n">push</span><span class="p">(</span> <span class="vi">@property_row</span> <span class="p">)</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_playlist_end</span>
</span><span class='line'>      <span class="vi">@library_callbacks</span><span class="o">.</span><span class="n">playlist_end</span> <span class="vi">@playlist</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_top_level_value</span>
</span><span class='line'>      <span class="k">unless</span> <span class="o">[</span> <span class="s2">&quot;tracks&quot;</span><span class="p">,</span> <span class="s2">&quot;playlists&quot;</span> <span class="o">].</span><span class="n">any?</span> <span class="p">{</span> <span class="o">|</span><span class="n">tlk</span><span class="o">|</span>
</span><span class='line'>          <span class="vi">@top_level_key</span> <span class="o">==</span> <span class="n">tlk</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="vi">@library_callbacks</span><span class="o">.</span><span class="n">top_level_row</span> <span class="vi">@property_row</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_top_level_key</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_tracks_collection_end</span>
</span><span class='line'>     <span class="vi">@library_callbacks</span><span class="o">.</span><span class="n">tracks_collection_end</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_playlists_collection_end</span>
</span><span class='line'>     <span class="vi">@library_callbacks</span><span class="o">.</span><span class="n">playlists_collection_end</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">is_top_level</span>
</span><span class='line'>      <span class="vi">@library_callbacks</span><span class="o">.</span><span class="n">top_level_end</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">element_name</span> <span class="o">==</span> <span class="s2">&quot;plist&quot;</span>
</span><span class='line'>      <span class="vi">@library_callbacks</span><span class="o">.</span><span class="n">library_end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">breadcrumb_remove</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#breadcrumbs are stores xpath style, i.e. /path/to/node</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">breadcrumb_add</span> <span class="n">element_name</span>
</span><span class='line'>    <span class="vi">@breadcrumb</span> <span class="o">=</span> <span class="vi">@breadcrumb</span> <span class="o">+</span> <span class="vi">@separator</span> <span class="o">+</span> <span class="n">element_name</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#breadcrumbs are stores xpath style, i.e. /path/to/node</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">breadcrumb_remove</span>
</span><span class='line'>    <span class="n">temp</span> <span class="o">=</span> <span class="vi">@breadcrumb</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="vi">@separator</span> <span class="p">)</span>
</span><span class='line'>    <span class="n">temp</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span class='line'>    <span class="vi">@element_name</span> <span class="o">=</span> <span class="n">temp</span><span class="o">[-</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@breadcrumb</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="vi">@separator</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#matches the very first dict after plist</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_top_level</span>
</span><span class='line'>    <span class="k">return</span> <span class="s2">&quot;/plist/dict&quot;</span> <span class="o">==</span> <span class="vi">@breadcrumb</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#the key a top level plist property</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_top_level_key</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">[</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/key&#39;</span>
</span><span class='line'>      <span class="o">].</span><span class="n">any?</span> <span class="p">{</span> <span class="o">|</span><span class="n">bc</span><span class="o">|</span>
</span><span class='line'>        <span class="vi">@breadcrumb</span> <span class="o">===</span> <span class="n">bc</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#the value a top level plist property</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_top_level_value</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">[</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/integer&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/string&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/true&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/false&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/date&#39;</span>
</span><span class='line'>      <span class="o">].</span><span class="n">any?</span> <span class="p">{</span> <span class="o">|</span><span class="n">bc</span><span class="o">|</span>
</span><span class='line'>        <span class="vi">@breadcrumb</span> <span class="o">===</span> <span class="n">bc</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#main container for tracks</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_tracks_collection_start</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span> <span class="s1">&#39;tracks&#39;</span> <span class="o">==</span> <span class="vi">@top_level_key</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>      <span class="p">(</span> <span class="s2">&quot;/plist/dict/dict&quot;</span> <span class="o">==</span> <span class="vi">@breadcrumb</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#main container for tracks</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_tracks_collection_end</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span> <span class="n">is_tracks_collection_start</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>      <span class="p">(</span> <span class="s2">&quot;dict&quot;</span> <span class="o">==</span> <span class="vi">@element_name</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#the start of a track</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_track_start</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span> <span class="s1">&#39;tracks&#39;</span> <span class="o">==</span> <span class="vi">@top_level_key</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>      <span class="s2">&quot;/plist/dict/dict/key&quot;</span> <span class="o">==</span> <span class="vi">@breadcrumb</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#the key for one of the tracks&#39; attributes</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_track_key</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span> <span class="s1">&#39;tracks&#39;</span> <span class="o">==</span> <span class="vi">@top_level_key</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>      <span class="s2">&quot;/plist/dict/dict/dict/key&quot;</span> <span class="o">==</span> <span class="vi">@breadcrumb</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#the value for one of the tracks&#39; attributes</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_track_value</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span> <span class="s1">&#39;tracks&#39;</span> <span class="o">==</span> <span class="vi">@top_level_key</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">[</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/dict/dict/integer&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/dict/dict/string&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/dict/dict/true&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/dict/dict/false&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/dict/dict/date&#39;</span>
</span><span class='line'>      <span class="o">].</span><span class="n">any?</span> <span class="p">{</span> <span class="o">|</span><span class="n">bc</span><span class="o">|</span>
</span><span class='line'>        <span class="vi">@breadcrumb</span> <span class="o">===</span> <span class="n">bc</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#the key for one of the tracks&#39; attributes</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_playlist_key</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span> <span class="s1">&#39;playlists&#39;</span> <span class="o">==</span> <span class="vi">@top_level_key</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>      <span class="s2">&quot;/plist/dict/array/dict/key&quot;</span> <span class="o">==</span> <span class="vi">@breadcrumb</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#the value for one of the tracks&#39; attributes</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_playlist_value</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span> <span class="s1">&#39;playlists&#39;</span> <span class="o">==</span> <span class="vi">@top_level_key</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">[</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/array/dict/integer&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/array/dict/string&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/array/dict/true&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/array/dict/false&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/array/dict/date&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/array/dict/data&#39;</span>
</span><span class='line'>      <span class="o">].</span><span class="n">any?</span> <span class="p">{</span> <span class="o">|</span><span class="n">bc</span><span class="o">|</span>
</span><span class='line'>        <span class="vi">@breadcrumb</span> <span class="o">===</span> <span class="n">bc</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#a single track with all its attributes</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_track_end</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span> <span class="s1">&#39;tracks&#39;</span> <span class="o">==</span> <span class="vi">@top_level_key</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>      <span class="s2">&quot;/plist/dict/dict/dict&quot;</span> <span class="o">==</span> <span class="vi">@breadcrumb</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#main container for playlists</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_playlists_collection_start</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span> <span class="s1">&#39;playlists&#39;</span> <span class="o">==</span> <span class="vi">@top_level_key</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>      <span class="p">(</span> <span class="s2">&quot;/plist/dict/array&quot;</span> <span class="o">==</span> <span class="vi">@breadcrumb</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#main container for playlists</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_playlists_collection_end</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span> <span class="n">is_playlists_collection_start</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>      <span class="p">(</span> <span class="s2">&quot;array&quot;</span> <span class="o">==</span> <span class="vi">@element_name</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#the start of a playlist</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_playlist_start</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span> <span class="s1">&#39;playlists&#39;</span> <span class="o">==</span> <span class="vi">@top_level_key</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>      <span class="s2">&quot;/plist/dict/array/dict&quot;</span> <span class="o">==</span> <span class="vi">@breadcrumb</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#the end of a playlist</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_playlist_end</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span> <span class="n">is_playlist_start</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>      <span class="s2">&quot;dict&quot;</span> <span class="o">==</span> <span class="vi">@element_name</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#the start of a playlist</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_playlist_items_start</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span> <span class="s1">&#39;playlist items&#39;</span> <span class="o">==</span> <span class="vi">@last_key</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>      <span class="s2">&quot;/plist/dict/array/dict/key&quot;</span> <span class="o">==</span> <span class="vi">@breadcrumb</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#non-important</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_playlist_items_key</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span> <span class="s1">&#39;playlist items&#39;</span> <span class="o">==</span> <span class="vi">@last_key</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">[</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/array/dict/array/dict&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/array/dict/array/dict/key&#39;</span>
</span><span class='line'>      <span class="o">].</span><span class="n">any?</span> <span class="p">{</span> <span class="o">|</span><span class="n">bc</span><span class="o">|</span>
</span><span class='line'>        <span class="vi">@breadcrumb</span> <span class="o">===</span> <span class="n">bc</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#non-important</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is_playlist_items_value</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span> <span class="s1">&#39;playlist items&#39;</span> <span class="o">==</span> <span class="vi">@last_key</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">[</span>
</span><span class='line'>      <span class="s1">&#39;/plist/dict/array/dict/array/dict/integer&#39;</span>
</span><span class='line'>      <span class="o">].</span><span class="n">any?</span> <span class="p">{</span> <span class="o">|</span><span class="n">bc</span><span class="o">|</span>
</span><span class='line'>        <span class="vi">@breadcrumb</span> <span class="o">===</span> <span class="n">bc</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#breadcrumbs are stores xpath style, i.e. /path/to/node</span>
</span><span class='line'>  <span class="c1">#this methods counts the slashes to determine the dept</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">depth</span>
</span><span class='line'>    <span class="vi">@breadcrumb</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span> <span class="s2">&quot;/&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">error</span> <span class="n">error_message</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s2">&quot;ERROR: </span><span class="si">#{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Because iTunes specific callbacks are now in another class, tests are much easier to write, if a bit tedious. The ITunesCallbacksTest creates an instance of the ITunesCallbacks class and passes it an ITunesLibraryWriter mock. The test check the mock receive all the expected events. The parsing is done manually by calling start_element and all the other SAX methods. I could have created a few mock files and passed them on instead, but this will do for now.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;flexmock/test_unit&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;ITunesLibraryCallbacks&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;ITunesLibraryWriter&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;test/unit&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ITunesLibraryCallbacksTest</span> <span class="o">&lt;</span> <span class="no">Test</span><span class="o">::</span><span class="no">Unit</span><span class="o">::</span><span class="no">TestCase</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">=</span> <span class="n">flexmock</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@ITunesLibraryWriter</span> <span class="o">=</span> <span class="n">flexmock</span><span class="p">(</span> <span class="no">ITunesLibraryWriter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span> <span class="p">),</span>
</span><span class='line'>                                    <span class="s2">&quot;ITunesLibraryWriter&quot;</span>
</span><span class='line'>                                    <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_tracks_collection_start</span>
</span><span class='line'>    <span class="vi">@ITunesLibraryWriter</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;tracks_collection_start&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">once</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryCallbacks</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span><span class="p">,</span> <span class="vi">@ITunesLibraryWriter</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;plist&quot;</span><span class="p">,</span> <span class="o">[</span> <span class="ss">:version</span> <span class="o">=&gt;</span> <span class="s2">&quot;1.0&quot;</span> <span class="o">]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">characters</span> <span class="s2">&quot;Tracks&quot;</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_playlists_collection_start</span>
</span><span class='line'>    <span class="vi">@ITunesLibraryWriter</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;playlists_collection_start&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">once</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryCallbacks</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span><span class="p">,</span> <span class="vi">@ITunesLibraryWriter</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;plist&quot;</span><span class="p">,</span> <span class="o">[</span> <span class="ss">:version</span> <span class="o">=&gt;</span> <span class="s2">&quot;1.0&quot;</span> <span class="o">]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">characters</span> <span class="s2">&quot;Playlists&quot;</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_top_level_start</span>
</span><span class='line'>    <span class="vi">@ITunesLibraryWriter</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;top_level_start&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">once</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryCallbacks</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span><span class="p">,</span> <span class="vi">@ITunesLibraryWriter</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;plist&quot;</span><span class="p">,</span> <span class="o">[</span> <span class="ss">:version</span> <span class="o">=&gt;</span> <span class="s2">&quot;1.0&quot;</span> <span class="o">]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_track_end</span>
</span><span class='line'>    <span class="c1">#&lt;dict&gt;</span>
</span><span class='line'>    <span class="c1">#&lt;key&gt;45543&lt;/key&gt;</span>
</span><span class='line'>    <span class="c1">#&lt;dict&gt;</span>
</span><span class='line'>    <span class="c1">#  &lt;key&gt;Track ID&lt;/key&gt;&lt;integer&gt;45543&lt;/integer&gt;</span>
</span><span class='line'>    <span class="c1">#  &lt;key&gt;Name&lt;/key&gt;&lt;string&gt;Fifths (Jazzanova 6 Sickth Mix)&lt;/string&gt;</span>
</span><span class='line'>    <span class="c1">#  &lt;key&gt;Artist&lt;/key&gt;&lt;string&gt;Ski&lt;/string&gt;</span>
</span><span class='line'>    <span class="c1">#  &lt;key&gt;Album&lt;/key&gt;&lt;string&gt;Jazzanova: The Remixes, 1997-2000&lt;/string&gt;</span>
</span><span class='line'>    <span class="c1">#&lt;/dict&gt;</span>
</span><span class='line'>    <span class="n">track</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:dict</span> <span class="o">=&gt;</span> <span class="o">[</span>
</span><span class='line'>        <span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">&quot;Track ID&quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="s2">&quot;John&quot;</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">&quot;Name&quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="s2">&quot;Ski&quot;</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">&quot;Artist&quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="s2">&quot;Jazzanova: The Remixes, 1997-2000&quot;</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">&quot;Album&quot;</span><span class="p">}</span>
</span><span class='line'>      <span class="o">]</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:key</span> <span class="o">=&gt;</span> <span class="mi">2</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="vi">@ITunesLibraryWriter</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;track_end&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="n">track</span> <span class="p">)</span><span class="o">.</span><span class="n">once</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryCallbacks</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span><span class="p">,</span> <span class="vi">@ITunesLibraryWriter</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;plist&quot;</span><span class="p">,</span> <span class="o">[</span> <span class="ss">:version</span> <span class="o">=&gt;</span> <span class="s2">&quot;1.0&quot;</span> <span class="o">]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">characters</span> <span class="s2">&quot;Tracks&quot;</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">characters</span> <span class="mi">2</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">characters</span> <span class="s2">&quot;Track ID&quot;</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">characters</span> <span class="mi">2</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;integer&quot;</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">characters</span> <span class="s2">&quot;Name&quot;</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">characters</span> <span class="s2">&quot;John&quot;</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;string&quot;</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">characters</span> <span class="s2">&quot;Artist&quot;</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">characters</span> <span class="s2">&quot;Ski&quot;</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;string&quot;</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">characters</span> <span class="s2">&quot;Album&quot;</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">characters</span> <span class="s2">&quot;Jazzanova: The Remixes, 1997-2000&quot;</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;string&quot;</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;dict&quot;</span>  <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_playlist_end</span>
</span><span class='line'>    <span class="n">playlist</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:dict</span><span class="o">=&gt;[</span>
</span><span class='line'>        <span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="s2">&quot;John&quot;</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">&quot;Name&quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">&quot;Eyes&quot;</span><span class="p">}</span>
</span><span class='line'>      <span class="o">]</span><span class="p">}</span>
</span><span class='line'>    <span class="vi">@ITunesLibraryWriter</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;playlist_end&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="n">playlist</span> <span class="p">)</span><span class="o">.</span><span class="n">once</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryCallbacks</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span><span class="p">,</span> <span class="vi">@ITunesLibraryWriter</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;plist&quot;</span><span class="p">,</span> <span class="o">[</span> <span class="ss">:version</span> <span class="o">=&gt;</span> <span class="s2">&quot;1.0&quot;</span> <span class="o">]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">characters</span> <span class="s2">&quot;playlists&quot;</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">characters</span> <span class="s2">&quot;Name&quot;</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">characters</span> <span class="s2">&quot;John&quot;</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;string&quot;</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">characters</span> <span class="s2">&quot;Eyes&quot;</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">characters</span> <span class="mi">2</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;integer&quot;</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;dict&quot;</span>  <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_top_level_row</span>
</span><span class='line'>    <span class="c1">#&lt;key&gt;Application Version&lt;/key&gt;&lt;string&gt;10.6.3&lt;/string&gt;</span>
</span><span class='line'>    <span class="n">property_row</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="s2">&quot;10.6.3&quot;</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">&quot;Application Version&quot;</span><span class="p">}</span>
</span><span class='line'>    <span class="vi">@ITunesLibraryWriter</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;top_level_row&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="n">property_row</span> <span class="p">)</span><span class="o">.</span><span class="n">once</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryCallbacks</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span><span class="p">,</span> <span class="vi">@ITunesLibraryWriter</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;plist&quot;</span><span class="p">,</span> <span class="o">[</span> <span class="ss">:version</span> <span class="o">=&gt;</span> <span class="s2">&quot;1.0&quot;</span> <span class="o">]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">characters</span> <span class="s2">&quot;Application Version&quot;</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">characters</span> <span class="s2">&quot;10.6.3&quot;</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;string&quot;</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_tracks_collection_end</span>
</span><span class='line'>    <span class="vi">@ITunesLibraryWriter</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;tracks_collection_end&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">once</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryCallbacks</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span><span class="p">,</span> <span class="vi">@ITunesLibraryWriter</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;plist&quot;</span><span class="p">,</span> <span class="o">[</span> <span class="ss">:version</span> <span class="o">=&gt;</span> <span class="s2">&quot;1.0&quot;</span> <span class="o">]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">characters</span> <span class="s2">&quot;Tracks&quot;</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;dict&quot;</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_playlists_collection_end</span>
</span><span class='line'>    <span class="vi">@ITunesLibraryWriter</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;playlists_collection_end&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">once</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryCallbacks</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span><span class="p">,</span> <span class="vi">@ITunesLibraryWriter</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;plist&quot;</span><span class="p">,</span> <span class="o">[</span> <span class="ss">:version</span> <span class="o">=&gt;</span> <span class="s2">&quot;1.0&quot;</span> <span class="o">]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">characters</span> <span class="s2">&quot;Playlists&quot;</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;dict&quot;</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_top_level_end</span>
</span><span class='line'>    <span class="vi">@ITunesLibraryWriter</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;top_level_end&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">once</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryCallbacks</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span><span class="p">,</span> <span class="vi">@ITunesLibraryWriter</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;plist&quot;</span><span class="p">,</span> <span class="o">[</span> <span class="ss">:version</span> <span class="o">=&gt;</span> <span class="s2">&quot;1.0&quot;</span> <span class="o">]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="o">[]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;dict&quot;</span>  <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_library_end</span>
</span><span class='line'>    <span class="vi">@ITunesLibraryWriter</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;library_end&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">once</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryCallbacks</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span><span class="p">,</span> <span class="vi">@ITunesLibraryWriter</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">start_element</span><span class="p">(</span> <span class="s2">&quot;plist&quot;</span><span class="p">,</span> <span class="o">[</span> <span class="ss">:version</span> <span class="o">=&gt;</span> <span class="s2">&quot;1.0&quot;</span> <span class="o">]</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLCInstance</span><span class="o">.</span><span class="n">end_element</span><span class="p">(</span> <span class="s2">&quot;plist&quot;</span>  <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>ITunesLibraryWriter is the new class that handles all the writing and the business logic. It&#8217;s pretty simple, in the end it is just a pretty printer.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># =ITunesLibraryWriter</span>
</span><span class='line'><span class="c1"># responds to event raised by ITunesLibraryCallbacks</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ITunesLibraryWriter</span>
</span><span class='line'>  <span class="kp">attr_accessor</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#takes a filehandler as argument</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span> <span class="o">*</span><span class="n">args</span> <span class="p">)</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">args</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>    <span class="k">when</span> <span class="mi">1</span>
</span><span class='line'>      <span class="vi">@filehandle</span>   <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">&quot;This class takes 1 argument.&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="vi">@node_separator</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">       &quot;</span>
</span><span class='line'>    <span class="vi">@track_separator</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#called by ITunesLibraryEvent</span>
</span><span class='line'>  <span class="c1">#prints a complete playlist</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">playlist_end</span> <span class="n">playlist</span>
</span><span class='line'>      <span class="n">playlist_print</span> <span class="n">playlist</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#called by ITunesLibraryEvent</span>
</span><span class='line'>  <span class="c1">#prints a complete track</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">track_end</span> <span class="n">track</span>
</span><span class='line'>      <span class="n">track_print</span> <span class="n">track</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#called by ITunesLibraryEvent</span>
</span><span class='line'>  <span class="c1">#prints the opening plist tag</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">library_start</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;&lt;plist version=&quot;1.0&quot;&gt;&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#called by ITunesLibraryEvent</span>
</span><span class='line'>  <span class="c1">#prints the opening plist tag</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">library_end</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;/plist&gt;&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#called by ITunesLibraryEvent</span>
</span><span class='line'>  <span class="c1">#prints the opening dict tag</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">top_level_start</span> <span class="n">element_name</span><span class="o">=</span><span class="s2">&quot;dict&quot;</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;</span><span class="si">#{</span><span class="n">element_name</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#called by ITunesLibraryEvent</span>
</span><span class='line'>  <span class="c1">#prints the closing dict tag</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">top_level_end</span> <span class="n">element_name</span><span class="o">=</span><span class="s2">&quot;dict&quot;</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;/</span><span class="si">#{</span><span class="n">element_name</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#called by ITunesLibraryEvent</span>
</span><span class='line'>  <span class="c1">#prints the opening dict tag for tracks</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">tracks_collection_start</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&lt;key&gt;Tracks&lt;/key&gt;</span><span class="se">\n\t</span><span class="s2">&lt;dict&gt;&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#called by ITunesLibraryEvent</span>
</span><span class='line'>  <span class="c1">#prints the opening dict tag for tracks</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">playlists_collection_start</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&lt;key&gt;Playlists&lt;/key&gt;</span><span class="se">\n\t</span><span class="s2">&lt;array&gt;&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#called by ITunesLibraryEvent</span>
</span><span class='line'>  <span class="c1">#prints the closing dict tag for tracks</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">tracks_collection_end</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&lt;/dict&gt;&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#called by ITunesLibraryEvent</span>
</span><span class='line'>  <span class="c1">#prints the closing dict tag for playlists</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">playlists_collection_end</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&lt;/array&gt;&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#called by ITunesLibraryEvent</span>
</span><span class='line'>  <span class="c1">#prints the opening dict tag</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">top_level_row</span> <span class="n">row</span>
</span><span class='line'>    <span class="n">track_row_print</span> <span class="n">row</span><span class="p">,</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#prints a complete playlist</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">playlist_print</span> <span class="n">playlist</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="vi">@track_separator</span> <span class="o">+</span> <span class="s2">&quot;&lt;dict&gt;&quot;</span>
</span><span class='line'>    <span class="n">playlist</span><span class="o">[</span><span class="ss">:dict</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
</span><span class='line'>      <span class="n">track_row_print</span> <span class="n">row</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="kp">nil</span> <span class="o">!=</span> <span class="n">playlist</span><span class="o">[</span><span class="ss">:items</span><span class="o">]</span>
</span><span class='line'>      <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="se">\n\t\t\t</span><span class="s2">&lt;key&gt;Playlist Items&lt;/key&gt;</span><span class="se">\n\t\t\t</span><span class="s2">&lt;array&gt;&quot;</span>
</span><span class='line'>      <span class="n">playlist</span><span class="o">[</span><span class="ss">:items</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
</span><span class='line'>        <span class="n">playlist_item_row_print</span> <span class="n">row</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="se">\n\t\t\t</span><span class="s2">&lt;/array&gt;&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="vi">@track_separator</span> <span class="o">+</span> <span class="s2">&quot;&lt;/dict&gt;&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#prints a complete track</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">track_print</span> <span class="n">track</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="vi">@track_separator</span> <span class="o">+</span> <span class="s2">&quot;&lt;key&gt;</span><span class="si">#{</span><span class="n">track</span><span class="o">[</span><span class="ss">:key</span><span class="o">]</span><span class="si">}</span><span class="s2">&lt;/key&gt;&quot;</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="vi">@track_separator</span> <span class="o">+</span> <span class="s2">&quot;&lt;dict&gt;&quot;</span>
</span><span class='line'>    <span class="n">track</span><span class="o">[</span><span class="ss">:dict</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
</span><span class='line'>      <span class="n">track_row_print</span> <span class="n">row</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="vi">@track_separator</span> <span class="o">+</span> <span class="s2">&quot;&lt;/dict&gt;&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#prints the row generated by track_row_string</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">track_row_print</span> <span class="n">row</span><span class="p">,</span> <span class="n">tabs</span><span class="o">=</span><span class="mi">3</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="n">track_row_string</span><span class="p">(</span> <span class="n">row</span><span class="p">,</span> <span class="n">tabs</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#prints the row generated by track_row_string</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">playlist_item_row_print</span> <span class="n">row</span><span class="p">,</span> <span class="n">tabs</span><span class="o">=</span><span class="mi">5</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="se">\n\t\t\t\t</span><span class="s2">&lt;dict&gt;&quot;</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="n">track_row_string</span><span class="p">(</span> <span class="n">row</span><span class="p">,</span> <span class="n">tabs</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="se">\n\t\t\t\t</span><span class="s2">&lt;/dict&gt;&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#takes an hash with { :key :value :type } and outputs</span>
</span><span class='line'>  <span class="c1">#    &lt;key&gt;KEY&lt;/key&gt;&lt;TYPE&gt;VALUE&lt;/TYPE&gt;</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">track_row_string</span> <span class="n">row</span><span class="p">,</span> <span class="n">tabs</span><span class="o">=</span><span class="mi">3</span>
</span><span class='line'>    <span class="n">k</span> <span class="o">=</span> <span class="n">row</span><span class="o">[</span><span class="ss">:key</span><span class="o">]</span>
</span><span class='line'>    <span class="n">v</span> <span class="o">=</span> <span class="n">row</span><span class="o">[</span><span class="ss">:value</span><span class="o">]</span>
</span><span class='line'>    <span class="n">t</span> <span class="o">=</span> <span class="n">row</span><span class="o">[</span><span class="ss">:type</span><span class="o">]</span>
</span><span class='line'>    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="p">(</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">*</span><span class="n">tabs</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&lt;key&gt;</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">&lt;/key&gt;&lt;</span><span class="si">#{</span><span class="n">t</span><span class="si">}</span><span class="s2">&gt;</span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="s2">&lt;/</span><span class="si">#{</span><span class="n">t</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The unit tests are also relatively simple</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;flexmock/test_unit&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;ITunesLibraryWriter&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;test/unit&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ITunesLibraryWriterTest</span> <span class="o">&lt;</span> <span class="no">Test</span><span class="o">::</span><span class="no">Unit</span><span class="o">::</span><span class="no">TestCase</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">=</span> <span class="n">flexmock</span><span class="p">(</span> <span class="s2">&quot;filehandle&quot;</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_library_start</span>
</span><span class='line'>    <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s1">&#39;&lt;plist version=&quot;1.0&quot;&gt;&#39;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLWInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryWriter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLWInstance</span><span class="o">.</span><span class="n">library_start</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_library_end</span>
</span><span class='line'>    <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;/plist&gt;&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLWInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryWriter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLWInstance</span><span class="o">.</span><span class="n">library_end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_playlist_end</span>
</span><span class='line'>    <span class="n">playlist</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:dict</span><span class="o">=&gt;[</span>
</span><span class='line'>        <span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="s2">&quot;John&quot;</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">&quot;Name&quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">&quot;Eyes&quot;</span><span class="p">}</span>
</span><span class='line'>      <span class="o">]</span><span class="p">}</span>
</span><span class='line'>    <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &lt;dict&gt;&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n\t\t\t</span><span class="s2">&lt;key&gt;Name&lt;/key&gt;&lt;string&gt;John&lt;/string&gt;&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n\t\t\t</span><span class="s2">&lt;key&gt;Eyes&lt;/key&gt;&lt;integer&gt;2&lt;/integer&gt;&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &lt;/dict&gt;&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLWInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryWriter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLWInstance</span><span class="o">.</span><span class="n">playlist_end</span> <span class="n">playlist</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_track_end</span>
</span><span class='line'>    <span class="n">track</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:dict</span> <span class="o">=&gt;</span> <span class="o">[</span>
</span><span class='line'>        <span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">&quot;Track ID&quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="s2">&quot;John&quot;</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">&quot;Name&quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="s2">&quot;Ski&quot;</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">&quot;Artist&quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="s2">&quot;Jazzanova: The Remixes, 1997-2000&quot;</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">&quot;Album&quot;</span><span class="p">}</span>
</span><span class='line'>      <span class="o">]</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:key</span> <span class="o">=&gt;</span> <span class="mi">2</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &lt;key&gt;2&lt;/key&gt;&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &lt;dict&gt;&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n\t\t\t</span><span class="s2">&lt;key&gt;Track ID&lt;/key&gt;&lt;integer&gt;2&lt;/integer&gt;&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n\t\t\t</span><span class="s2">&lt;key&gt;Name&lt;/key&gt;&lt;string&gt;John&lt;/string&gt;&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n\t\t\t</span><span class="s2">&lt;key&gt;Artist&lt;/key&gt;&lt;string&gt;Ski&lt;/string&gt;&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n\t\t\t</span><span class="s2">&lt;key&gt;Album&lt;/key&gt;&lt;string&gt;Jazzanova: The Remixes, 1997-2000&lt;/string&gt;&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &lt;/dict&gt;&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLWInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryWriter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLWInstance</span><span class="o">.</span><span class="n">track_end</span> <span class="n">track</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_top_level_start</span>
</span><span class='line'>    <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;dict&gt;&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLWInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryWriter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLWInstance</span><span class="o">.</span><span class="n">top_level_start</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_top_level_end</span>
</span><span class='line'>    <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;/dict&gt;&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLWInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryWriter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLWInstance</span><span class="o">.</span><span class="n">top_level_end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_tracks_collection_start</span>
</span><span class='line'>    <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&lt;key&gt;Tracks&lt;/key&gt;</span><span class="se">\n\t</span><span class="s2">&lt;dict&gt;&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLWInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryWriter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLWInstance</span><span class="o">.</span><span class="n">tracks_collection_start</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_tracks_collection_end</span>
</span><span class='line'>    <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&lt;/dict&gt;&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLWInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryWriter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLWInstance</span><span class="o">.</span><span class="n">tracks_collection_end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_playlists_collection_start</span>
</span><span class='line'>    <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&lt;key&gt;Playlists&lt;/key&gt;</span><span class="se">\n\t</span><span class="s2">&lt;array&gt;&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLWInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryWriter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLWInstance</span><span class="o">.</span><span class="n">playlists_collection_start</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_playlists_collection_end</span>
</span><span class='line'>    <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&lt;/array&gt;&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLWInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryWriter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLWInstance</span><span class="o">.</span><span class="n">playlists_collection_end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_top_level_row</span>
</span><span class='line'>    <span class="n">row</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="s2">&quot;10.6.3&quot;</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">&quot;Application Version&quot;</span><span class="p">}</span>
</span><span class='line'>    <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&lt;key&gt;Application Version&lt;/key&gt;&lt;string&gt;10.6.3&lt;/string&gt;&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLWInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryWriter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@iTLWInstance</span><span class="o">.</span><span class="n">top_level_row</span> <span class="n">row</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Creating a playlist of missing iTunes tracks</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='gherkin'><span class='line'><span class="k">Scenario:</span><span class="nf"> Creating a playlist of missing iTunes tracks</span>
</span><span class='line'><span class="k">        Given </span><span class="nf">that &quot;</span><span class="s">itunes XML library</span><span class="nf">&quot; contains references to X files</span>
</span><span class='line'><span class="nf">        </span><span class="k">And </span><span class="nf">only </span><span class="s">8</span><span class="nf"> of these are in &quot;</span><span class="s">folder</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">        </span><span class="k">When </span><span class="nf">I run itunesfiddler with input &quot;</span><span class="s">itunes XML library</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">        </span><span class="k">And </span><span class="nf">folder &quot;</span><span class="s">folder</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">        </span><span class="k">And </span><span class="nf">command &quot;</span><span class="s">keep_missing_only</span><span class="nf">&quot;</span>
</span><span class='line'><span class="nf">        </span><span class="k">Then </span><span class="nf">it should create a Library file with the two missing files only</span>
</span><span class='line'><span class="nf">        </span><span class="k">And </span><span class="nf">no playlists</span>
</span></code></pre></td></tr></table></div></figure>


<p>To finish off, I wanted to create at least a useful utility, which is what the whole point of this challenge was (as well as learning Ruby).</p>

<p>I am always swapping hard disks around for backing up. Since my playlist is huge, sometimes iTunes gives up and tells me it couldn&#8217;t copy all the files - but with no indication of what the missing files were. A utility that could compare the original iTunes library with the files in the new location, and create a playlist including only the files that weren&#8217;t copied over would be quite useful.</p>

<p>This shouldn&#8217;t be too hard too achieve. First of all the script needs to be able to read in the new parameters, so that it knows what it is expected to do and where to look for files. Then I will subclass ITunesLibraryWriter and overwrite the playlist writer method (to do nothing - I don&#8217;t need playlists, only tracks), and the track writing method (to only write if the file wasn&#8217;t found).</p>

<h4>Changing the main shell script to take commands</h4>

<p>itunesfiddler is changed so that it now accept command names. I also made &#8211;input optional - got bored of typing it&#8230;</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#reads command line args</span>
</span><span class='line'><span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'><span class="n">itunesfiddler</span> <span class="o">=</span> <span class="no">OptionParser</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">opt</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#help screen</span>
</span><span class='line'>  <span class="n">opt</span><span class="o">.</span><span class="n">banner</span> <span class="o">=</span> <span class="s2">&quot;Usage: itunesfiddler --input=FILE [OPTIONS] [COMMAND]&quot;</span>
</span><span class='line'>  <span class="n">opt</span><span class="o">.</span><span class="n">separator</span>  <span class="s2">&quot;&quot;</span>
</span><span class='line'>  <span class="n">opt</span><span class="o">.</span><span class="n">separator</span>  <span class="s2">&quot;Commands&quot;</span>
</span><span class='line'>  <span class="n">opt</span><span class="o">.</span><span class="n">separator</span>  <span class="s2">&quot;   keep_missing_only - only includes track not found in folder, and doesn&#39;t print out any playlists. Requires --folder option&quot;</span>
</span><span class='line'>  <span class="n">opt</span><span class="o">.</span><span class="n">separator</span>  <span class="s2">&quot;Options&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#individual options</span>
</span><span class='line'>  <span class="n">opt</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;-i&quot;</span><span class="p">,</span><span class="s2">&quot;--input SRC&quot;</span><span class="p">,</span><span class="s2">&quot;input xml file, default iTunes Music Library.xml&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">src</span><span class="o">|</span>
</span><span class='line'>    <span class="n">options</span><span class="o">[</span><span class="ss">:src</span><span class="o">]</span> <span class="o">=</span> <span class="n">src</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">opt</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;-o&quot;</span><span class="p">,</span><span class="s2">&quot;--output [TARGET]&quot;</span><span class="p">,</span><span class="s2">&quot;output xml file&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">target</span><span class="o">|</span>
</span><span class='line'>    <span class="n">options</span><span class="o">[</span><span class="ss">:target</span><span class="o">]</span> <span class="o">=</span> <span class="n">target</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">opt</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;-f&quot;</span><span class="p">,</span><span class="s2">&quot;--folder [FOLDER]&quot;</span><span class="p">,</span><span class="s2">&quot;folder where files are, or should be, copied to&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">folder</span><span class="o">|</span>
</span><span class='line'>    <span class="n">options</span><span class="o">[</span><span class="ss">:folder</span><span class="o">]</span> <span class="o">=</span> <span class="n">folder</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">opt</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;-h&quot;</span><span class="p">,</span><span class="s2">&quot;--help&quot;</span><span class="p">,</span><span class="s2">&quot;help&quot;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="n">itunesfiddler</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#collects args and quits if something wrong</span>
</span><span class='line'><span class="n">itunesfiddler</span><span class="o">.</span><span class="n">parse!</span>
</span><span class='line'>
</span><span class='line'><span class="k">unless</span> <span class="n">options</span><span class="o">[</span><span class="ss">:src</span><span class="o">]</span>
</span><span class='line'>  <span class="n">options</span><span class="o">[</span><span class="ss">:src</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;iTunes Music Library.xml&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">unless</span> <span class="no">File</span><span class="o">.</span><span class="n">file?</span> <span class="n">options</span><span class="o">[</span><span class="ss">:src</span><span class="o">]</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="n">itunesfiddler</span>
</span><span class='line'>  <span class="nb">abort</span><span class="p">(</span> <span class="s2">&quot;ERROR: missing --input file - tried </span><span class="si">#{</span><span class="n">options</span><span class="o">[</span><span class="ss">:src</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">unless</span> <span class="n">options</span><span class="o">[</span><span class="ss">:target</span><span class="o">]</span>
</span><span class='line'>  <span class="n">options</span><span class="o">[</span><span class="ss">:target</span><span class="o">]</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:src</span><span class="o">].</span><span class="n">clone</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot; - new&quot;</span> <span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>A big switch statement associates an ITunesLibraryWriter (sub)class with a command. Not the most elegant approach, but it will do for now. The class I will be creating now is ITunesLibraryWriterKeepMissingOnly</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#collection of callbacks for SAX parser</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;ITunesLibraryCallbacks&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#copies file over</span>
</span><span class='line'><span class="nb">open</span><span class="p">(</span> <span class="n">options</span><span class="o">[</span><span class="ss">:target</span><span class="o">]</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span> <span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">open</span><span class="p">(</span> <span class="n">options</span><span class="o">[</span><span class="ss">:src</span><span class="o">]</span> <span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">#the top two lines are not easily dealt with by SAX, so done manually</span>
</span><span class='line'>    <span class="n">f</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">.</span><span class="n">readline</span>
</span><span class='line'>    <span class="n">f</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">.</span><span class="n">readline</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#FIXME something more elegant is on its way</span>
</span><span class='line'>  <span class="c1">#each command gets its own subclass of SAX::Document</span>
</span><span class='line'>  <span class="k">case</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">when</span> <span class="s2">&quot;keep_missing_only&quot;</span>
</span><span class='line'>    <span class="k">unless</span> <span class="n">options</span><span class="o">[</span><span class="ss">:folder</span><span class="o">]</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="n">itunesfiddler</span>
</span><span class='line'>      <span class="nb">abort</span><span class="p">(</span> <span class="s2">&quot;ERROR: missing --folder&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">require</span> <span class="s2">&quot;ITunesLibraryWriterKeepMissingOnly&quot;</span>
</span><span class='line'>    <span class="vg">$iTLCInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryCallbacks</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="n">f</span><span class="p">,</span> <span class="no">ITunesLibraryWriterKeepMissingOnly</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="n">f</span><span class="p">,</span> <span class="n">options</span><span class="o">[</span><span class="ss">:folder</span><span class="o">]</span> <span class="p">)</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="vg">$iTLCInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryCallbacks</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="n">f</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">parser</span> <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">XML</span><span class="o">::</span><span class="no">SAX</span><span class="o">::</span><span class="no">Parser</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vg">$iTLCInstance</span> <span class="p">)</span>
</span><span class='line'>  <span class="n">parser</span><span class="o">.</span><span class="n">parse_file</span><span class="p">(</span> <span class="n">options</span><span class="o">[</span><span class="ss">:src</span><span class="o">]</span> <span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;done - </span><span class="si">#{</span><span class="vg">$iTLCInstance</span><span class="o">.</span><span class="n">track_count</span><span class="si">}</span><span class="s2"> tracks, created:</span><span class="si">#{</span><span class="n">options</span><span class="o">[</span><span class="ss">:target</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="nb">exit</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Setting up ITunesLibraryWriterKeepMissingOnly</h4>

<p>Now that I got unit tests in place I can start using TDD for the rest. First task, ensure playlists are not written out - they only increase the file size needlessly.</p>

<p>First of all I created a blank ITunesLibraryWriterKeepMissingOnly file</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># =ITunesLibraryWriterKeepMissingOnly</span>
</span><span class='line'><span class="c1"># keeps only the files which are not found in @folder</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;ITunesLibraryWriter&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ITunesLibraryWriterKeepMissingOnly</span> <span class="o">&lt;</span> <span class="no">ITunesLibraryWriter</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then I duplicated the ITunesLibraryWriterTest file and renamed the test class ITunesLibraryWriterKeepMissingOnlyTest - it should just run as it is, as none of the methods were overwritten. And it does.</p>

<p>I want to force the class to read in a new paramter - folder, so I added a test</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="vi">@filehandle</span> <span class="o">=</span> <span class="n">flexmock</span><span class="p">(</span> <span class="s2">&quot;filehandle&quot;</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@folder</span> <span class="o">=</span> <span class="s2">&quot;tracks/&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_instantiation</span>
</span><span class='line'>    <span class="n">assert_raise</span><span class="p">(</span><span class="no">ArgumentError</span><span class="p">)</span> <span class="p">{</span> <span class="vi">@iTLWInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryWriterKeepMissingOnly</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span> <span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>To pass it, I amended the class as</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#takes a filehandler as argument</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span> <span class="o">*</span><span class="n">args</span> <span class="p">)</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">args</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>    <span class="k">when</span> <span class="mi">2</span>
</span><span class='line'>      <span class="vi">@filehandle</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>      <span class="vi">@folder</span>     <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">&quot;This class takes 2 argument.&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that test passes, but all the others failed as they still only pass in one argument. I changed them all to two. I can now delete all the tests that are not relevant, and change the ones I want to overwrite.</p>

<h4>Making ITunesLibraryWriterKeepMissingOnly not write out output</h4>

<p>Playlists are written at the end of a playlist block, so the relevant event is playlist_end. Here&#8217;s the test</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_playlist_end</span>
</span><span class='line'>  <span class="n">playlist</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:dict</span><span class="o">=&gt;[</span>
</span><span class='line'>      <span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="s2">&quot;John&quot;</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">&quot;Name&quot;</span><span class="p">},</span>
</span><span class='line'>      <span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">&quot;Eyes&quot;</span><span class="p">}</span>
</span><span class='line'>    <span class="o">]</span><span class="p">}</span>
</span><span class='line'>  <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">never</span>
</span><span class='line'>  <span class="vi">@iTLWInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryWriterKeepMissingOnly</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span><span class="p">,</span> <span class="vi">@folder</span> <span class="p">)</span>
</span><span class='line'>  <span class="vi">@iTLWInstance</span><span class="o">.</span><span class="n">playlist_end</span> <span class="n">playlist</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The code to pass it couldn&#8217;t be easier - just do nothing</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">playlist_end</span> <span class="n">playlist</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Storing meta information</h4>

<p>Tracks are also written at the end of the corresponding block. Each track&#8217;s path is stored under the key Location, so in theory it should be easy to look up whether a file in that location actually exists in &#8211;folder. But before doing that, in each path I need to replace the folder the tracks were copied <em>from</em>, i.e. the original iTunes library folder, with the folder the paths are being copied <em>to</em>. But where do I get hold of the iTunes library folder path?</p>

<p>One of the top level keys in the iTunes XML plist is Music Folder, which is exactly what I need. But nowhere in my code is this information stored, it is just copied over. In fact, it would be a good idea to store <em>all</em> those top level properties in an object - there are only a handful. I will add a new method, meta to the parent ITunesLibraryWriter class</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_meta</span>
</span><span class='line'>  <span class="n">folder_key</span> <span class="o">=</span> <span class="s2">&quot;Music Folder&quot;</span>
</span><span class='line'>  <span class="n">folder_value</span> <span class="o">=</span> <span class="s2">&quot;file://localhost/Volumes/HD1T/Music/&quot;</span>
</span><span class='line'>  <span class="n">row</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="n">folder_value</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="n">folder_key</span> <span class="p">}</span>
</span><span class='line'>  <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span>
</span><span class='line'>  <span class="vi">@iTLWInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryWriter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span> <span class="p">)</span>
</span><span class='line'>  <span class="vi">@iTLWInstance</span><span class="o">.</span><span class="n">top_level_row</span> <span class="n">row</span>
</span><span class='line'>  <span class="n">assert_equal</span><span class="p">(</span> <span class="n">folder_value</span><span class="p">,</span> <span class="vi">@iTLWInstance</span><span class="o">.</span><span class="n">meta</span><span class="p">(</span> <span class="n">folder_key</span> <span class="p">)</span> <span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the implementation - @top_level is created in the initialize method</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#called by ITunesLibraryEvent</span>
</span><span class='line'><span class="c1">#prints the opening dict tag</span>
</span><span class='line'><span class="k">def</span> <span class="nf">top_level_row</span> <span class="n">row</span>
</span><span class='line'>  <span class="vi">@top_level</span><span class="o">[</span><span class="n">row</span><span class="o">[</span><span class="ss">:key</span><span class="o">]]</span> <span class="o">=</span> <span class="n">row</span><span class="o">[</span><span class="ss">:value</span><span class="o">]</span>
</span><span class='line'>  <span class="n">track_row_print</span> <span class="n">row</span><span class="p">,</span> <span class="mi">1</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#top level keys are saved in a global object. this method returns it</span>
</span><span class='line'><span class="k">def</span> <span class="nf">meta</span> <span class="n">the_key</span>
</span><span class='line'>  <span class="k">return</span> <span class="vi">@top_level</span><span class="o">[</span><span class="n">the_key</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Copying tracks only if the file doesn&#8217;t exist in &#8211;folder</h4>

<p>Now it should be possible to check those files. Two new test: one for files that are not there, and one for files that are.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_track_exists</span>
</span><span class='line'>  <span class="n">folder_key</span> <span class="o">=</span> <span class="s2">&quot;Music Folder&quot;</span>
</span><span class='line'>  <span class="n">folder_value</span> <span class="o">=</span> <span class="s2">&quot;file://localhost/Volumes/HD1T/Music/&quot;</span>
</span><span class='line'>  <span class="n">row</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="n">folder_value</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="n">folder_key</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">track</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:dict</span> <span class="o">=&gt;</span> <span class="o">[</span>
</span><span class='line'>      <span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">&quot;Track ID&quot;</span><span class="p">},</span>
</span><span class='line'>      <span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="s2">&quot;Tonton Du Bled&quot;</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">&quot;Name&quot;</span><span class="p">},</span>
</span><span class='line'>      <span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span> <span class="n">folder_value</span> <span class="o">+</span> <span class="s2">&quot;113/Tonton%20Du%20Bled/Tonton%20Du%20Bled.mp3&quot;</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">&quot;Location&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="o">]</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:key</span> <span class="o">=&gt;</span> <span class="mi">2</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&lt;key&gt;Music Folder&lt;/key&gt;&lt;string&gt;file://localhost/Volumes/HD1T/Music/&lt;/string&gt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">once</span>
</span><span class='line'>  <span class="vi">@iTLWInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryWriterKeepMissingOnly</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span><span class="p">,</span> <span class="vi">@folder</span> <span class="p">)</span>
</span><span class='line'>  <span class="vi">@iTLWInstance</span><span class="o">.</span><span class="n">top_level_row</span> <span class="n">row</span>
</span><span class='line'>  <span class="vi">@iTLWInstance</span><span class="o">.</span><span class="n">track_end</span> <span class="n">track</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">test_track_doesnt_exist</span>
</span><span class='line'>  <span class="n">folder_key</span> <span class="o">=</span> <span class="s2">&quot;Music Folder&quot;</span>
</span><span class='line'>  <span class="n">folder_value</span> <span class="o">=</span> <span class="s2">&quot;file://localhost/Volumes/HD1T/Music/&quot;</span>
</span><span class='line'>  <span class="n">row</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="n">folder_value</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="n">folder_key</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">track</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:dict</span> <span class="o">=&gt;</span> <span class="o">[</span>
</span><span class='line'>      <span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="mi">3</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">&quot;Track ID&quot;</span><span class="p">},</span>
</span><span class='line'>      <span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span><span class="s2">&quot;Tonton Du Bled&quot;</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">&quot;Name&quot;</span><span class="p">},</span>
</span><span class='line'>      <span class="p">{</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="ss">:value</span><span class="o">=&gt;</span> <span class="n">folder_value</span> <span class="o">+</span> <span class="s2">&quot;113/ThisDoesNotExist.mp3&quot;</span><span class="p">,</span> <span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">&quot;Location&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="o">]</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:key</span> <span class="o">=&gt;</span> <span class="mi">3</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&lt;key&gt;Music Folder&lt;/key&gt;&lt;string&gt;file://localhost/Volumes/HD1T/Music/&lt;/string&gt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">once</span>
</span><span class='line'>  <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &lt;key&gt;3&lt;/key&gt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">once</span>
</span><span class='line'>  <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &lt;dict&gt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">once</span>
</span><span class='line'>  <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n\t\t\t</span><span class="s2">&lt;key&gt;Track ID&lt;/key&gt;&lt;integer&gt;3&lt;/integer&gt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">once</span>
</span><span class='line'>  <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n\t\t\t</span><span class="s2">&lt;key&gt;Name&lt;/key&gt;&lt;string&gt;Tonton Du Bled&lt;/string&gt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">once</span>
</span><span class='line'>  <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n\t\t\t</span><span class="s2">&lt;key&gt;Location&lt;/key&gt;&lt;string&gt;file://localhost/Volumes/HD1T/Music/113/ThisDoesNotExist.mp3&lt;/string&gt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">once</span>
</span><span class='line'>  <span class="vi">@filehandle</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span> <span class="s2">&quot;&lt;&lt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &lt;/dict&gt;&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">once</span>
</span><span class='line'>  <span class="vi">@iTLWInstance</span> <span class="o">=</span> <span class="no">ITunesLibraryWriterKeepMissingOnly</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="vi">@filehandle</span><span class="p">,</span> <span class="vi">@folder</span> <span class="p">)</span>
</span><span class='line'>  <span class="vi">@iTLWInstance</span><span class="o">.</span><span class="n">top_level_row</span> <span class="n">row</span>
</span><span class='line'>  <span class="vi">@iTLWInstance</span><span class="o">.</span><span class="n">track_end</span> <span class="n">track</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The code to pass them is fairly simple. I created a helper function to extract the file path from a track array of tuples, including URL-decoding them. Then all the track_end event handler has to do is to check that path, and only call the parent (super) method if the track wasn&#8217;t found.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#called by ITunesLibraryEvent</span>
</span><span class='line'><span class="k">def</span> <span class="nf">track_end</span> <span class="n">track</span>
</span><span class='line'>  <span class="k">unless</span> <span class="no">File</span><span class="o">.</span><span class="n">file?</span><span class="p">(</span> <span class="n">extract_pth</span><span class="p">(</span> <span class="n">track</span><span class="o">[</span><span class="ss">:dict</span><span class="o">]</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span> <span class="p">)</span> <span class="p">)</span>
</span><span class='line'>    <span class="k">super</span> <span class="n">track</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">extract_pth</span> <span class="n">the_array</span><span class="p">,</span> <span class="n">the_key</span>
</span><span class='line'>  <span class="n">the_array</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">tuple</span><span class="o">|</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">the_key</span> <span class="o">==</span> <span class="n">tuple</span><span class="o">[</span><span class="ss">:key</span><span class="o">]</span>
</span><span class='line'>      <span class="n">str</span> <span class="o">=</span>  <span class="no">URI</span><span class="o">.</span><span class="n">unescape</span><span class="p">(</span> <span class="n">tuple</span><span class="o">[</span><span class="ss">:value</span><span class="o">]</span> <span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="vi">@folder</span> <span class="o">+</span> <span class="n">str</span><span class="o">[</span><span class="n">meta</span><span class="p">(</span> <span class="s2">&quot;Music Folder&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">.</span><span class="n">.</span> <span class="n">str</span><span class="o">.</span><span class="n">size</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="kp">nil</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It works a treat.</p>

<h2>Challenge 100% complete</h2>

<p>Farily happy with this - it was reasonably straightforward, it gets the job done, it allowed me to get to know Ruby, and I got the foundation for a flexible system. The code is far from perfect, it&#8217;s just the bare minimum to pass the tests, but that&#8217;s the point of TDD - I can go back and refactor it without fear of breaking everything.</p>

<p>The scripts are <a href="https://github.com/gotofritz/Weekly-Challenges/tree/master/weekly-challenge-23_ruby-itunes-fiddler">available on GitHub</a>.</p>
</div>
	</div>
</article>

<article class="archives">
  <div class="related-posts">
    <h2>Related Posts</h2>
    
      <article>
        <h3 class="title"><a href="/blog/geekery/jstestdriver-boilerplate/">JSTestDriver boilerplate</a></h3>
        <div class="meta">
          <span class="tags">


	<a class='category' href='/blog/cat/geekery/'>Geekery</a>


</span>
            
          <time datetime="2012-07-15T13:04:15+02:00" pubdate>2012-07-15</time>
            
        </div>
      </article>
    
      <article>
        <h3 class="title"><a href="/blog/howto/fixing-itunes-cannot-find-music">Fixing iTunes when it forgets the hard disk with all your music</a></h3>
        <div class="meta">
          <span class="tags">


	<a class='category' href='/blog/cat/howto/'>HowTo</a>


</span>
            
          <time datetime="2012-07-15T13:04:15+02:00" pubdate>2012-07-15</time>
            
        </div>
      </article>
    
      <article>
        <h3 class="title"><a href="/blog/howto/nested-conditionals-itunes-smart-playlists">Nested conditionals in iTunes smart playlists have gone?</a></h3>
        <div class="meta">
          <span class="tags">


	<a class='category' href='/blog/cat/howto/'>HowTo</a>


</span>
            
          <time datetime="2012-07-15T13:04:15+02:00" pubdate>2012-07-15</time>
            
        </div>
      </article>
    
  </div>
</article>


<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>

  </div>
	<footer id="footer" class="inner">Copyright &copy; 2015

    Fabrizio (Fritz) Stelluto

</footer>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script src="/javascripts/slash.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'goto-fritz';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://gotofritz.net/blog/weekly-challenge/manipulating-xml-itunes-library-ruby';
        var disqus_url = 'http://gotofritz.net/blog/weekly-challenge/manipulating-xml-itunes-library-ruby';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-11254155-2']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>