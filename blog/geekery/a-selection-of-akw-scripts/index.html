
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>A selection of akw scripts - Fabrizio (Fritz) Stelluto</title>
	<meta name="author" content="">

	
	<meta name="description" content="Some examples scripts to complement the previous awk tutorial All the scripts here assume the fields in the data is space separated - i.e. UK London &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Fabrizio (Fritz) Stelluto" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
	<link rel="icon" href="/favicon.gif" type="image/gif" />
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	
</head>


<body ontouchstart="">

  <header id="header" class="inner">
<nav id="main-nav"><div>
  <a class="rss" href="/atom.xml" title="RSS">RSS</a>
  <a href="/">home</a>
  <a href="/blog/">blog</a>
</div></nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><div>
  <a class="rss" href="/atom.xml" title="RSS">RSS</a>
  <a href="/">home</a>
  <a href="/blog/">blog</a>
</div></div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:gotofritz.net">
			</form>
		</div>
	</div>
</nav>

<nav id="sub-nav" class="alignright">
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:gotofritz.net">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner">
    
    <article class="post">
	<h1 class="title">A Selection of Akw Scripts</h1>
	<div>
		<div class="meta">
			<div class="date">








  


<time datetime="2015-07-25T00:16:00+02:00" pubdate data-updated="true">2015-07-25, Sat</time></div>
			<div class="tags">


	<a class='category' href='/blog/cat/geekery/'>Geekery</a>


</div>
			
				<span class="comments"><a href="/blog/geekery/a-selection-of-akw-scripts/#disqus_thread">Comments</a></span>
			
		</div>
		<div class="entry-content"><p>Some examples scripts to complement the previous <a href="/blog/geekery/back-to-the-classics-awk/">awk tutorial</a></p>

<!--more-->


<p>All the scripts here assume the fields in the data is space separated - i.e. <code>UK   London  10000</code> etc. There hasn&#8217;t been a CSV standard until recently, but the one you get from MS Office doesn&#8217;t work too well with awk, because CSV is basically a rubbish format and hard to handle. But if you have a &#8220;well behaved&#8221; CSV file, i.e. one which doesn&#8217;t have commas, quotation marks, or new lines inside fields, e.g <code>UK,London,10000</code> then you can easily process it by passing -F&#8221;,&#8221; to the awk call:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>awk -F<span class="s2">&quot;,&quot;</span> -f my_awk_script.awk some_input_data.txt
</span></code></pre></td></tr></table></div></figure>


<p>In practice unless you generate the data yourself there is always going to be the odd comma or quotation mark in your data somewhere, so I find it easier to convert the data to tab separated using a <a href="http://www.convertcsv.com/csv-to-csv.htm">free online CSV to TSV converter like this</a>. I then call awk with &#8220;\t&#8221; as the separator, because some field may have spaces inside them.</p>

<p>The command below is what I use - my awk program is in my_awk_script.awk, the data is in uk_electoral_data_converted.csv, and the results goes into awk_output.txt.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>awk -F<span class="s2">&quot;\t&quot;</span> -f my_awk_script.awk uk_electoral_data_converted.csv &gt; awk_output.txt
</span></code></pre></td></tr></table></div></figure>


<h3>Sample data: UK election results</h3>

<p>Some of the scripts will use <a href="http://is.gd/eUrbOZ">data from the 2015 UK election in CSV format</a> as data, converted to TSV. Here&#8217;s what it looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Forename  Surname Description on ballot paper Constituency Name PANO  Votes Share <span class="o">(</span>%<span class="o">)</span> Change  FIELD9  Incumbent?  FIELD11 Constituency ID Region ID County  Region  Country Constituency <span class="nb">type </span>Party name identifier Party abbreviation
</span><span class='line'>Gerald  Howarth The Conservative Party Candidate  Aldershot 7 23369 50.6  3.9   MP    E14000530 E12000008 Hampshire South East  England Borough Conservative  Con
</span><span class='line'>Gary  Puffett Labour Party  Aldershot 7 8468  18.3  6.2       E14000530 E12000008 Hampshire South East  England Borough Labour  Lab
</span><span class='line'>Bill  Walker  UK Independence Party <span class="o">(</span>UKIP<span class="o">)</span>  Aldershot 7 8253  17.9  13.4        E14000530 E12000008 Hampshire South East  England Borough UK Independence Party UKIP
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>And here are the field names in order</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> 1 Forename
</span><span class='line'> 2 Surname
</span><span class='line'> 3 Description on ballot paper
</span><span class='line'> 4 Constituency Name
</span><span class='line'> 5 PANO
</span><span class='line'> 6 Votes
</span><span class='line'> 7 Share <span class="o">(</span>%<span class="o">)</span>
</span><span class='line'> 8 Change
</span><span class='line'> 9 --
</span><span class='line'>10 Incumbent?
</span><span class='line'>11 --
</span><span class='line'>12 Constituency ID
</span><span class='line'>13 Region ID
</span><span class='line'>14 County
</span><span class='line'>15 Region
</span><span class='line'>16 Country
</span><span class='line'>17 Constituency <span class="nb">type</span>
</span><span class='line'>18 Party name identifier
</span><span class='line'>19 Party abbreviation
</span></code></pre></td></tr></table></div></figure>


<h3>Skipping header row</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># put NR &gt; 1 in front of every action to skip the header row</span>
</span><span class='line'>NR &gt; 1 <span class="o">{</span> print <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># result</span>
</span><span class='line'>Gerald  Howarth The Conservative Party Candidate  Aldershot ...
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<h3>Skipping empty records</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># check if the first field is empty</span>
</span><span class='line'>NF <span class="o">{</span> print <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Rearranging fields, and skipping some</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>NR &gt; 1 <span class="o">&amp;&amp;</span> NF <span class="o">{</span> print <span class="nv">$4</span> <span class="s2">&quot;: &quot;</span> <span class="nv">$2</span> <span class="s2">&quot; &quot;</span> <span class="nv">$1</span> <span class="s2">&quot; (&quot;</span> <span class="nv">$NF</span> <span class="s2">&quot;) &quot;</span> <span class="nv">$7</span> <span class="s2">&quot;% &quot;</span> <span class="o">}</span>
</span><span class='line'><span class="c"># NR &gt; 1    ignore header</span>
</span><span class='line'><span class="c"># NF  ignore empty record</span>
</span><span class='line'><span class="c"># print constituence name, name surname, party abbreviation, share of the vote</span>
</span><span class='line'><span class="c"># ignore otehr fields</span>
</span><span class='line'>
</span><span class='line'>Aldershot: Howarth Gerald <span class="o">(</span>Con<span class="o">)</span> 50.6%
</span><span class='line'>Aldershot: Puffett Gary <span class="o">(</span>Lab<span class="o">)</span> 18.3%
</span><span class='line'>Aldershot: Walker Bill <span class="o">(</span>UKIP<span class="o">)</span> 17.9%
</span><span class='line'>Aldershot: Hilliar Alan <span class="o">(</span>LD<span class="o">)</span> 8.8%
</span><span class='line'>Aldershot: Hewitt Carl <span class="o">(</span>Green<span class="o">)</span> 4.4%
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<h3>Print sum of all fields</h3>

<p>Finds the national Conservative vote</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$NF</span> <span class="o">==</span> <span class="s2">&quot;Con&quot;</span> <span class="o">{</span>total +<span class="o">=</span> <span class="nv">$6</span><span class="o">}</span>
</span><span class='line'>END          <span class="o">{</span>print total<span class="o">}</span>
</span><span class='line'><span class="c"># $NF == &quot;Con&quot;  if a record concerns a tory vote</span>
</span><span class='line'><span class="c"># {total += $6} add it to a running total</span>
</span><span class='line'><span class="c"># END           when all records are processed</span>
</span><span class='line'><span class="c"># {print total} output total</span>
</span><span class='line'>
</span><span class='line'>11299609
</span></code></pre></td></tr></table></div></figure>


<h3>Work out column averages</h3>

<p>Find the total vote of the 6 larger parties and their % of the national vote</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># keep a running total</span>
</span><span class='line'>NR &gt; 1 <span class="o">&amp;&amp;</span> NF  <span class="o">{</span>total +<span class="o">=</span> <span class="nv">$6</span><span class="o">}</span>
</span><span class='line'><span class="c"># keep a total for each party - don&#39; do anything yet</span>
</span><span class='line'><span class="nv">$NF</span> <span class="o">==</span> <span class="s2">&quot;Con&quot;</span>        <span class="o">{</span>total_con +<span class="o">=</span> <span class="nv">$6</span><span class="o">}</span>
</span><span class='line'><span class="nv">$NF</span> <span class="o">==</span> <span class="s2">&quot;Lab&quot;</span>        <span class="o">{</span>total_lab +<span class="o">=</span> <span class="nv">$6</span><span class="o">}</span>
</span><span class='line'><span class="nv">$NF</span> <span class="o">==</span> <span class="s2">&quot;UKIP&quot;</span>       <span class="o">{</span>total_ukip +<span class="o">=</span> <span class="nv">$6</span><span class="o">}</span>
</span><span class='line'><span class="nv">$NF</span> <span class="o">==</span> <span class="s2">&quot;LD&quot;</span>         <span class="o">{</span>total_ld +<span class="o">=</span> <span class="nv">$6</span><span class="o">}</span>
</span><span class='line'><span class="nv">$NF</span> <span class="o">==</span> <span class="s2">&quot;Green&quot;</span>      <span class="o">{</span>total_green +<span class="o">=</span> <span class="nv">$6</span><span class="o">}</span>
</span><span class='line'><span class="nv">$NF</span> <span class="o">==</span> <span class="s2">&quot;SNP&quot;</span>        <span class="o">{</span>total_snp +<span class="o">=</span> <span class="nv">$6</span><span class="o">}</span>
</span><span class='line'><span class="c"># print a report at the end</span>
</span><span class='line'>END <span class="o">{</span>
</span><span class='line'>  print <span class="s2">&quot;TOTAL: &quot;</span> total
</span><span class='line'>  print <span class="s2">&quot;Con:   &quot;</span> <span class="o">(</span>100 * total_con / total<span class="o">)</span> <span class="s2">&quot;%&quot;</span>
</span><span class='line'>  print <span class="s2">&quot;Lab:   &quot;</span> <span class="o">(</span>100 * total_lab / total<span class="o">)</span> <span class="s2">&quot;%&quot;</span>
</span><span class='line'>  print <span class="s2">&quot;UKIP:  &quot;</span> <span class="o">(</span>100 * total_ukip / total<span class="o">)</span> <span class="s2">&quot;%&quot;</span>
</span><span class='line'>  print <span class="s2">&quot;LD:    &quot;</span> <span class="o">(</span>100 * total_ld / total<span class="o">)</span> <span class="s2">&quot;%&quot;</span>
</span><span class='line'>  print <span class="s2">&quot;SNP:   &quot;</span> <span class="o">(</span>100 * total_snp / total<span class="o">)</span> <span class="s2">&quot;%&quot;</span>
</span><span class='line'>  print <span class="s2">&quot;Green: &quot;</span> <span class="o">(</span>100 * total_green / total<span class="o">)</span> <span class="s2">&quot;%&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># output:</span>
</span><span class='line'>TOTAL: 30697255
</span><span class='line'>Con:   36.8098%
</span><span class='line'>Lab:   30.449%
</span><span class='line'>UKIP:  12.6431%
</span><span class='line'>LD:    7.87014%
</span><span class='line'>SNP:   4.738%
</span><span class='line'>Green: 3.77112%
</span></code></pre></td></tr></table></div></figure>


<h3>Using functions</h3>

<p>The same as above, but without copy and paste code</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># abstracting copy-and-paste code into a function</span>
</span><span class='line'><span class="k">function </span>print_party_percentage<span class="o">(</span>party_name, party_vote, total_vote<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  print party_name <span class="s2">&quot;   &quot;</span> <span class="o">(</span>100 * party_vote / total_vote<span class="o">)</span> <span class="s2">&quot;%&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="c"># same program as before</span>
</span><span class='line'>NR &gt; 1 <span class="o">&amp;&amp;</span> NF   <span class="o">{</span>total +<span class="o">=</span> <span class="nv">$6</span><span class="o">}</span>
</span><span class='line'><span class="nv">$NF</span> <span class="o">==</span> <span class="s2">&quot;Con&quot;</span>   <span class="o">{</span>total_con +<span class="o">=</span> <span class="nv">$6</span><span class="o">}</span>
</span><span class='line'><span class="nv">$NF</span> <span class="o">==</span> <span class="s2">&quot;Lab&quot;</span>   <span class="o">{</span>total_lab +<span class="o">=</span> <span class="nv">$6</span><span class="o">}</span>
</span><span class='line'><span class="nv">$NF</span> <span class="o">==</span> <span class="s2">&quot;UKIP&quot;</span>  <span class="o">{</span>total_ukip +<span class="o">=</span> <span class="nv">$6</span><span class="o">}</span>
</span><span class='line'><span class="nv">$NF</span> <span class="o">==</span> <span class="s2">&quot;LD&quot;</span>    <span class="o">{</span>total_ld +<span class="o">=</span> <span class="nv">$6</span><span class="o">}</span>
</span><span class='line'><span class="nv">$NF</span> <span class="o">==</span> <span class="s2">&quot;Green&quot;</span> <span class="o">{</span>total_green +<span class="o">=</span> <span class="nv">$6</span><span class="o">}</span>
</span><span class='line'><span class="nv">$NF</span> <span class="o">==</span> <span class="s2">&quot;SNP&quot;</span>   <span class="o">{</span>total_snp +<span class="o">=</span> <span class="nv">$6</span><span class="o">}</span>
</span><span class='line'>END <span class="o">{</span>
</span><span class='line'>  print <span class="s2">&quot;TOTAL: &quot;</span> total
</span><span class='line'>  print_party_percentage<span class="o">(</span><span class="s2">&quot;Con&quot;</span>, total_con, total<span class="o">)</span>
</span><span class='line'>  print_party_percentage<span class="o">(</span><span class="s2">&quot;Lab&quot;</span>, total_lab, total<span class="o">)</span>
</span><span class='line'>  print_party_percentage<span class="o">(</span><span class="s2">&quot;UKIP&quot;</span>, total_ukip, total<span class="o">)</span>
</span><span class='line'>  print_party_percentage<span class="o">(</span><span class="s2">&quot;LD&quot;</span>, total_ld, total<span class="o">)</span>
</span><span class='line'>  print_party_percentage<span class="o">(</span><span class="s2">&quot;SNP&quot;</span>, total_snp, total<span class="o">)</span>
</span><span class='line'>  print_party_percentage<span class="o">(</span><span class="s2">&quot;Green&quot;</span>, total_green, total<span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># output - looks messier because previous program was manually formatted</span>
</span><span class='line'>TOTAL: 30697255
</span><span class='line'>Con   36.8098%
</span><span class='line'>Lab   30.449%
</span><span class='line'>UKIP   12.6431%
</span><span class='line'>LD   7.87014%
</span><span class='line'>SNP   4.738%
</span><span class='line'>Green   3.77112%
</span></code></pre></td></tr></table></div></figure>


<h3>Formatting numerical precision and alignment with printf</h3>

<p>Same as above, but using printf for formatting</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="k">function </span>print_party_percentage<span class="o">(</span>party_name, party_vote, total_vote<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">printf</span> <span class="s2">&quot;%5s: %4.1f%%\n&quot;</span>, party_name, <span class="o">(</span>100 * party_vote / total_vote<span class="o">)</span>
</span><span class='line'>  <span class="c"># %5s a string (s) of fixed width 5 or more (5) aligned right (if it was -5 it would be left)</span>
</span><span class='line'>  <span class="c"># %4.1f a number (f) with one decimal (.1) and total width 4 (4) aligned right (4)</span>
</span><span class='line'>  <span class="c"># %% an actual %</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="c"># same program as before</span>
</span><span class='line'>NR &gt; 1 <span class="o">&amp;&amp;</span> NF   <span class="o">{</span>total +<span class="o">=</span> <span class="nv">$6</span><span class="o">}</span>
</span><span class='line'><span class="nv">$NF</span> <span class="o">==</span> <span class="s2">&quot;Con&quot;</span>   <span class="o">{</span>total_con +<span class="o">=</span> <span class="nv">$6</span><span class="o">}</span>
</span><span class='line'><span class="nv">$NF</span> <span class="o">==</span> <span class="s2">&quot;Lab&quot;</span>   <span class="o">{</span>total_lab +<span class="o">=</span> <span class="nv">$6</span><span class="o">}</span>
</span><span class='line'><span class="nv">$NF</span> <span class="o">==</span> <span class="s2">&quot;UKIP&quot;</span>  <span class="o">{</span>total_ukip +<span class="o">=</span> <span class="nv">$6</span><span class="o">}</span>
</span><span class='line'><span class="nv">$NF</span> <span class="o">==</span> <span class="s2">&quot;LD&quot;</span>    <span class="o">{</span>total_ld +<span class="o">=</span> <span class="nv">$6</span><span class="o">}</span>
</span><span class='line'><span class="nv">$NF</span> <span class="o">==</span> <span class="s2">&quot;Green&quot;</span> <span class="o">{</span>total_green +<span class="o">=</span> <span class="nv">$6</span><span class="o">}</span>
</span><span class='line'><span class="nv">$NF</span> <span class="o">==</span> <span class="s2">&quot;SNP&quot;</span>   <span class="o">{</span>total_snp +<span class="o">=</span> <span class="nv">$6</span><span class="o">}</span>
</span><span class='line'>END <span class="o">{</span>
</span><span class='line'>  print <span class="s2">&quot;TOTAL: &quot;</span> total
</span><span class='line'>  print_party_percentage<span class="o">(</span><span class="s2">&quot;Con&quot;</span>, total_con, total<span class="o">)</span>
</span><span class='line'>  print_party_percentage<span class="o">(</span><span class="s2">&quot;Lab&quot;</span>, total_lab, total<span class="o">)</span>
</span><span class='line'>  print_party_percentage<span class="o">(</span><span class="s2">&quot;UKIP&quot;</span>, total_ukip, total<span class="o">)</span>
</span><span class='line'>  print_party_percentage<span class="o">(</span><span class="s2">&quot;LD&quot;</span>, total_ld, total<span class="o">)</span>
</span><span class='line'>  print_party_percentage<span class="o">(</span><span class="s2">&quot;SNP&quot;</span>, total_snp, total<span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># output</span>
</span><span class='line'>TOTAL: 30697255
</span><span class='line'>  Con: 36.8%
</span><span class='line'>  Lab: 30.4%
</span><span class='line'> UKIP: 12.6%
</span><span class='line'>   LD:  7.9%
</span><span class='line'>  SNP:  4.7%
</span></code></pre></td></tr></table></div></figure>


<h3>Using arrays to group data</h3>

<p>There is still some copy and past code because we are hardcoding the parties. We can use arrays to group whatever parties we find.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># same formatting function as before</span>
</span><span class='line'><span class="k">function </span>print_party_percentage<span class="o">(</span>party_name, party_vote, total_vote<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">printf</span> <span class="s2">&quot;%5s: %4.1f%%\n&quot;</span>, party_name, <span class="o">(</span>100 * party_vote / total_vote<span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># skip empty and header lines</span>
</span><span class='line'>NR &gt; 1 <span class="o">&amp;&amp;</span> NF  <span class="o">{</span>
</span><span class='line'>  <span class="c"># runnint total</span>
</span><span class='line'>  total +<span class="o">=</span> <span class="nv">$6</span>
</span><span class='line'>  <span class="c"># create or update running total for current party</span>
</span><span class='line'>  party_totals<span class="o">[</span><span class="nv">$NF</span><span class="o">]</span> +<span class="o">=</span> <span class="nv">$6</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="c"># when all records are processed</span>
</span><span class='line'>END <span class="o">{</span>
</span><span class='line'>  print <span class="s2">&quot;TOTAL: &quot;</span> total
</span><span class='line'>  <span class="c"># print a line for each party</span>
</span><span class='line'>  <span class="k">for</span> <span class="o">(</span>party in party_totals<span class="o">)</span>
</span><span class='line'>    print_party_percentage<span class="o">(</span>party, party_totals<span class="o">[</span>party<span class="o">]</span>, total<span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># output - there are a LOT of tiny local parties</span>
</span><span class='line'>TOTAL: 30697255
</span><span class='line'>  UUP:  0.4%
</span><span class='line'>Left Unity - Trade Unionists and Socialists:  0.0%
</span><span class='line'>  IZB:  0.0%
</span><span class='line'>Respect:  0.0%
</span><span class='line'>  SSP:  0.0%
</span><span class='line'>  NSW:  0.0%
</span><span class='line'>The 30-50 Coalition:  0.0%
</span><span class='line'>.... and so on
</span></code></pre></td></tr></table></div></figure>


<p>Oh - turns out if you include all the novelty parties there are 132 of them across the UK. We need to sort the array and only print the top X items. Turns out it is quite complicated.</p>

<h3>Sorting array</h3>

<p>Standard awk&#8217;s array are not sortable. This was a design choice - only associative arrays are supported, so there is no order, hence they can&#8217;t be sorted in any meaningful way. <a href="https://www.gnu.org/software/gawk/manual/gawk.html#Arrays">gawk, however, has two array sorting functions</a> - how do they do it? They actually create a new associative array, with all the values from the original but none of they keys; they keys are replaced by new ones, in order. Then you use a for loop (not the standard for in) to read all the array &#8220;in order&#8221;. This is all well and good if you don&#8217;t need the keys, but I do (they are the name of the party). Besides, I am using awk and not gawk.</p>

<p>The best approach is to create a new array with just the keys, sort that array, and then loop through it in order in order to find out which keys of the original array to read.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># kickstarts the sort process</span>
</span><span class='line'><span class="c"># puts all the sorted keys into a separate array. if i</span>
</span><span class='line'><span class="k">function </span>homebrew_asort<span class="o">(</span>original, processed<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="c"># before we use the array we must be sure it is empty</span>
</span><span class='line'>  empty_array<span class="o">(</span>processed<span class="o">)</span>
</span><span class='line'>  <span class="nv">original_length</span> <span class="o">=</span> copy_and_count_array<span class="o">(</span>original, processed<span class="o">)</span>
</span><span class='line'>  qsort<span class="o">(</span>original, processed, 0, original_length<span class="o">)</span>
</span><span class='line'>  <span class="k">return </span>original_length
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># removes al values</span>
</span><span class='line'><span class="k">function </span>empty_array<span class="o">(</span>A<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">for</span> <span class="o">(</span>i in A<span class="o">)</span>
</span><span class='line'>    delete A<span class="o">[</span>i<span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># awk doesn&#39;t even have an array size function... you also have to roll out your own</span>
</span><span class='line'><span class="k">function </span>copy_and_count_array<span class="o">(</span>original, processed<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">for</span> <span class="o">(</span>key in original<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="c"># awk doesn&#39;t seem to like array[0] -  so we start from 1</span>
</span><span class='line'>    size++
</span><span class='line'>    processed<span class="o">[</span>size<span class="o">]</span> <span class="o">=</span> key
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">return </span>size
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Adapted from a script from awk.info</span>
</span><span class='line'><span class="c"># http://awk.info/?quicksort</span>
</span><span class='line'><span class="k">function </span>qsort<span class="o">(</span>original, keys, left, right,   i, last<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span>left &gt;<span class="o">=</span> right<span class="o">)</span>  <span class="k">return</span>
</span><span class='line'><span class="k">  </span>swap<span class="o">(</span>keys, left, left + int<span class="o">(</span> <span class="o">(</span>right - left + 1<span class="o">)</span> * rand<span class="o">()</span> <span class="o">)</span> <span class="o">)</span>
</span><span class='line'>  <span class="nv">last</span> <span class="o">=</span> left
</span><span class='line'>  <span class="k">for</span> <span class="o">(</span><span class="nv">i</span> <span class="o">=</span> left+1; i &lt;<span class="o">=</span> right; i++<span class="o">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span>original<span class="o">[</span>keys<span class="o">[</span>i<span class="o">]]</span> &lt; original<span class="o">[</span>keys<span class="o">[</span>left<span class="o">]])</span>
</span><span class='line'>      swap<span class="o">(</span>keys, ++last, i<span class="o">)</span>
</span><span class='line'>  swap<span class="o">(</span>keys, left, last<span class="o">)</span>
</span><span class='line'>  qsort<span class="o">(</span>original, keys, left, last-1<span class="o">)</span>
</span><span class='line'>  qsort<span class="o">(</span>original, keys, last+1, right<span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="k">function </span>swap<span class="o">(</span>A, i, j,   t<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">t</span> <span class="o">=</span> A<span class="o">[</span>i<span class="o">]</span>; A<span class="o">[</span>i<span class="o">]</span> <span class="o">=</span> A<span class="o">[</span>j<span class="o">]</span>; A<span class="o">[</span>j<span class="o">]</span> <span class="o">=</span> t
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># same formatting function as before</span>
</span><span class='line'><span class="k">function </span>print_party_percentage<span class="o">(</span>party_name, party_vote, total_vote<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">printf</span> <span class="s2">&quot;%5s: %4.1f%%\n&quot;</span>, party_name, <span class="o">(</span>100 * party_vote / total_vote<span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># same main action as before</span>
</span><span class='line'>NR &gt; 1 <span class="o">&amp;&amp;</span> NF  <span class="o">{</span>
</span><span class='line'>  total +<span class="o">=</span> <span class="nv">$6</span>
</span><span class='line'>  party_totals<span class="o">[</span><span class="nv">$NF</span><span class="o">]</span> +<span class="o">=</span> <span class="nv">$6</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># when all records are processed</span>
</span><span class='line'>END <span class="o">{</span>
</span><span class='line'>  <span class="nv">parties_count</span> <span class="o">=</span> homebrew_asort<span class="o">(</span>party_totals, keys<span class="o">)</span>
</span><span class='line'>  <span class="k">for</span>  <span class="o">(</span><span class="nv">i</span> <span class="o">=</span> parties_count; i &gt;<span class="o">=</span> parties_count - 5; i--<span class="o">)</span>
</span><span class='line'>    print_party_percentage<span class="o">(</span>keys<span class="o">[</span>i<span class="o">]</span>, party_totals<span class="o">[</span>keys<span class="o">[</span>i<span class="o">]]</span>, total<span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the output</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>  Con: 36.8%
</span><span class='line'>  Lab: 30.4%
</span><span class='line'> UKIP: 12.6%
</span><span class='line'>   LD:  7.9%
</span><span class='line'>  SNP:  4.7%
</span><span class='line'>Green:  3.8%
</span></code></pre></td></tr></table></div></figure>


<h2>Other examples</h2>

<p>The <a href="http://awk.info/">awk.info</a> website has some <a href="http://awk.info/?OneLiners">one liners</a> with extensive <a href="http://www.catonmat.net/blog/awk-one-liners-explained-part-one/">explanations</a></p>

<p>The <a href="http://www.math.utah.edu/docs/info/gawk_4.html">gawk manual includes some one liners</a> which are compatible with standard awk.</p>

<p>The Unix School: <a href="http://www.theunixschool.com/2012/06/awk-10-examples-to-group-data-in-csv-or.html">10 examples to group data in a CSV or text file</a></p>
</div>
	</div>
</article>

<article class="archives">
  <div class="related-posts">
    <h2>Related Posts</h2>
    
      <article>
        <h3 class="title"><a href="/blog/geekery/back-to-the-classics-awk/">Back to the classics: awk</a></h3>
        <div class="meta">
          <span class="tags">


	<a class='category' href='/blog/cat/geekery/'>Geekery</a>


</span>
            
          <time datetime="2015-07-25T00:16:00+02:00" pubdate>2015-07-25</time>
            
        </div>
      </article>
    
      <article>
        <h3 class="title"><a href="/blog/geekery/storing-bash-profile-and-so-on-on-github/">dotfiles</a></h3>
        <div class="meta">
          <span class="tags">


	<a class='category' href='/blog/cat/geekery/'>Geekery</a>


</span>
            
          <time datetime="2015-07-25T00:16:00+02:00" pubdate>2015-07-25</time>
            
        </div>
      </article>
    
  </div>
</article>


<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>

  </div>
	<footer id="footer" class="inner">Copyright &copy; 2015

    Fabrizio (Fritz) Stelluto

</footer>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script src="/javascripts/slash.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'goto-fritz';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://gotofritz.net/blog/geekery/a-selection-of-akw-scripts/';
        var disqus_url = 'http://gotofritz.net/blog/geekery/a-selection-of-akw-scripts/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-11254155-2']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>