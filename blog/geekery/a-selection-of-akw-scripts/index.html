<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <title>A selection of akw scripts || Fritz Stelluto</title>
  <meta name="author" content="gotofritz">
  <meta name="description" content="Some examples scripts to complement the previous awk tutorial">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link href="/assets/favicon.ico" rel="shortcut icon">
  <link rel="icon" href="/assets/favicon.gif" type="image/gif" />
  <link href="/assets/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
</head>

<body ontouchstart="">
  <header id="header" class="inner">
    <nav id="main-nav">
      <div>
        <a href="/">home</a>
        <a href="/blog/">blog</a>
      </div>
    </nav>

    <nav id="sub-nav" class="alignright">
      <form class="search" action="http://google.com/search" method="get">
        <input class="alignright" type="text" name="q" results="0">
        <input type="hidden" name="q" value="site:gotofritz.net">
      </form>
    </nav>
  </header>


<div id="content" class="inner">
  <article class="post">
    <h1 class="title">A selection of akw scripts</h1>
    <div>
      <div class="meta">
        <div class="date">
          <time datetime="2015-07-25T00:16:00+02:00" pubdate>2015-07-25</time>
        </div>
        <div class="tags">
          cli,
          awk
        </div>
      </div>
      <div class="entry-content">
    
<p>Some examples scripts to complement the previous <a href="/blog/geekery/back-to-the-classics-awk/">awk tutorial</a>
<!--more--></p>
<h2 id="input-data-format">Input data format</h2>
<p>One area where standard awk falls short is dealing with input files from your standard desktop applications - basically, CSV files from Office. There hasn&#39;t been a CSV standard until recently, and the CSV generated by MS Office doesn&#39;t work too well with awk. The main issue is that CSV is basically a rubbish format which suffers from a few problems: the comma too common a character to be used as a separator (why didn&#39;t they choose tab??), newlines are saved without being converted to a safe sequence, sometimes fields are surrounded by quotes and sometimes they aren&#39;t.</p>
<p>But if you have a &quot;well behaved&quot; CSV file, i.e. one which doesn&#39;t have commas, quotation marks, or new lines inside fields, e.g <code>UK,London,10000</code> then you can easily process it by passing -F&quot;,&quot; to the awk call:</p>
<pre><code>awk -F&quot;,&quot; -f my_awk_script.awk some_input_data.txt
</code></pre><p>In practice unless you generate the data yourself there is always going to be the odd comma or quotation mark in your data somewhere; the safest and most reliable course of action is to use tab as separator. I use a <a href="http://www.convertcsv.com/csv-to-csv.htm">free online CSV to TSV converter like this</a>. I then call awk with &quot;\t&quot; as the separator.</p>
<p>The command below is what I use - my awk program is in <code>my_awk_script.awk</code>, the data is in <code>uk_electoral_data_converted.csv</code>, and the results goes into <code>awk_output.txt</code>.</p>
<pre><code>awk -F&quot;\t&quot; -f my_awk_script.awk uk_electoral_data_converted.csv &gt; awk_output.txt
</code></pre><h3 id="sample-data-uk-election-results">Sample data: UK election results</h3>
<p>Some of the scripts will use <a href="http://is.gd/eUrbOZ">data from the 2015 UK election in CSV format</a> as data, converted to TSV. Here&#39;s what it looks like:</p>
<pre><code>Forename  Surname Description on ballot paper Constituency Name PANO  Votes Share (%) Change  FIELD9  Incumbent?  FIELD11 Constituency ID Region ID County  Region  Country Constituency type Party name identifier Party abbreviation
Gerald  Howarth The Conservative Party Candidate  Aldershot 7 23369 50.6  3.9   MP    E14000530 E12000008 Hampshire South East  England Borough Conservative  Con
Gary  Puffett Labour Party  Aldershot 7 8468  18.3  6.2       E14000530 E12000008 Hampshire South East  England Borough Labour  Lab
Bill  Walker  UK Independence Party (UKIP)  Aldershot 7 8253  17.9  13.4        E14000530 E12000008 Hampshire South East  England Borough UK Independence Party UKIP
...
</code></pre><p>And here are the field names in order</p>
<pre><code>1 Forename
2 Surname
3 Description on ballot paper
4 Constituency Name
5 PANO
6 Votes
7 Share (%)
8 Change
9 --
10 Incumbent?
11 --
12 Constituency ID
13 Region ID
14 County
15 Region
16 Country
17 Constituency type
18 Party name identifier
19 Party abbreviation
</code></pre><h3 id="skipping-header-row">Skipping header row</h3>
<pre><code># put NR &gt; 1 in front of every action to skip the header row
NR &gt; 1 { print }

# result
Gerald  Howarth The Conservative Party Candidate  Aldershot ...
...
</code></pre><h3 id="skipping-empty-records">Skipping empty records</h3>
<pre><code># check if the first field is empty
NF { print }
</code></pre><h3 id="rearranging-fields-and-skipping-some">Rearranging fields, and skipping some</h3>
<pre><code>NR &gt; 1 &amp;&amp; NF { print $4 &quot;: &quot; $2 &quot; &quot; $1 &quot; (&quot; $NF &quot;) &quot; $7 &quot;% &quot; }
# NR &gt; 1    ignore header
# NF  ignore empty record
# print constituency name, name surname, party abbreviation, share of the vote
# ignore other fields

Aldershot: Howarth Gerald (Con) 50.6%
Aldershot: Puffett Gary (Lab) 18.3%
Aldershot: Walker Bill (UKIP) 17.9%
Aldershot: Hilliar Alan (LD) 8.8%
Aldershot: Hewitt Carl (Green) 4.4%
...
</code></pre><h3 id="print-sum-of-all-fields">Print sum of all fields</h3>
<p>Finds the national Conservative vote</p>
<pre><code>$NF == &quot;Con&quot; {total += $6}
END          {print total}
# $NF == &quot;Con&quot;  if a record concerns a tory vote
# {total += $6} add it to a running total
# END           when all records are processed
# {print total} output total

11299609
</code></pre><h3 id="work-out-column-averages">Work out column averages</h3>
<p>Find the total vote of the 6 larger parties and their % of the national vote</p>
<pre><code># keep a running total
NR &gt; 1 &amp;&amp; NF  {total += $6}
# keep a total for each party - don&#39;t do anything yet
$NF == &quot;Con&quot;        {total_con += $6}
$NF == &quot;Lab&quot;        {total_lab += $6}
$NF == &quot;UKIP&quot;       {total_ukip += $6}
$NF == &quot;LD&quot;         {total_ld += $6}
$NF == &quot;Green&quot;      {total_green += $6}
$NF == &quot;SNP&quot;        {total_snp += $6}
# print a report at the end
END {
  print &quot;TOTAL: &quot; total
  print &quot;Con:   &quot; (100 * total_con / total) &quot;%&quot;
  print &quot;Lab:   &quot; (100 * total_lab / total) &quot;%&quot;
  print &quot;UKIP:  &quot; (100 * total_ukip / total) &quot;%&quot;
  print &quot;LD:    &quot; (100 * total_ld / total) &quot;%&quot;
  print &quot;SNP:   &quot; (100 * total_snp / total) &quot;%&quot;
  print &quot;Green: &quot; (100 * total_green / total) &quot;%&quot;
}

# output:
TOTAL: 30697255
Con:   36.8098%
Lab:   30.449%
UKIP:  12.6431%
LD:    7.87014%
SNP:   4.738%
Green: 3.77112%
</code></pre><h3 id="using-functions">Using functions</h3>
<p>The same as above, but without copy and paste code</p>
<pre><code># abstracting copy-and-paste code into a function
function print_party_percentage(party_name, party_vote, total_vote) {
  print party_name &quot;   &quot; (100 * party_vote / total_vote) &quot;%&quot;
}
# same program as before
NR &gt; 1 &amp;&amp; NF   {total += $6}
$NF == &quot;Con&quot;   {total_con += $6}
$NF == &quot;Lab&quot;   {total_lab += $6}
$NF == &quot;UKIP&quot;  {total_ukip += $6}
$NF == &quot;LD&quot;    {total_ld += $6}
$NF == &quot;Green&quot; {total_green += $6}
$NF == &quot;SNP&quot;   {total_snp += $6}
END {
  print &quot;TOTAL: &quot; total
  print_party_percentage(&quot;Con&quot;, total_con, total)
  print_party_percentage(&quot;Lab&quot;, total_lab, total)
  print_party_percentage(&quot;UKIP&quot;, total_ukip, total)
  print_party_percentage(&quot;LD&quot;, total_ld, total)
  print_party_percentage(&quot;SNP&quot;, total_snp, total)
  print_party_percentage(&quot;Green&quot;, total_green, total)
}

# output - looks messier because previous program was manually formatted
TOTAL: 30697255
Con   36.8098%
Lab   30.449%
UKIP   12.6431%
LD   7.87014%
SNP   4.738%
Green   3.77112%
</code></pre><h3 id="formatting-numerical-precision-and-alignment-with-printf">Formatting numerical precision and alignment with printf</h3>
<p>Same as above, but using printf for formatting</p>
<pre><code>function print_party_percentage(party_name, party_vote, total_vote) {
  printf &quot;%5s: %4.1f%%\n&quot;, party_name, (100 * party_vote / total_vote)
  # %5s a string (s) of fixed width 5 or more (5) aligned right (if it was -5 it would be left)
  # %4.1f a number (f) with one decimal (.1) and total width 4 (4) aligned right (4)
  # %% an actual %
}
# same program as before
NR &gt; 1 &amp;&amp; NF   {total += $6}
$NF == &quot;Con&quot;   {total_con += $6}
$NF == &quot;Lab&quot;   {total_lab += $6}
$NF == &quot;UKIP&quot;  {total_ukip += $6}
$NF == &quot;LD&quot;    {total_ld += $6}
$NF == &quot;Green&quot; {total_green += $6}
$NF == &quot;SNP&quot;   {total_snp += $6}
END {
  print &quot;TOTAL: &quot; total
  print_party_percentage(&quot;Con&quot;, total_con, total)
  print_party_percentage(&quot;Lab&quot;, total_lab, total)
  print_party_percentage(&quot;UKIP&quot;, total_ukip, total)
  print_party_percentage(&quot;LD&quot;, total_ld, total)
  print_party_percentage(&quot;SNP&quot;, total_snp, total)
}

# output
TOTAL: 30697255
  Con: 36.8%
  Lab: 30.4%
UKIP: 12.6%
  LD:  7.9%
  SNP:  4.7%
</code></pre><h3 id="using-arrays-to-group-data">Using arrays to group data</h3>
<p>There is still some copy and paste code because we are hardcoding the parties. We can use arrays to group whatever parties we find.</p>
<pre><code># same formatting function as before
function print_party_percentage(party_name, party_vote, total_vote) {
  printf &quot;%5s: %4.1f%%\n&quot;, party_name, (100 * party_vote / total_vote)
}

# skip empty and header lines
NR &gt; 1 &amp;&amp; NF  {
  # runnint total
  total += $6
  # create or update running total for current party
  party_totals[$NF] += $6
}
# when all records are processed
END {
  print &quot;TOTAL: &quot; total
  # print a line for each party
  for (party in party_totals)
    print_party_percentage(party, party_totals[party], total)
}

# output - there are LOTS of tiny local parties
TOTAL: 30697255
  UUP:  0.4%
Left Unity - Trade Unionists and Socialists:  0.0%
  IZB:  0.0%
Respect:  0.0%
  SSP:  0.0%
  NSW:  0.0%
The 30-50 Coalition:  0.0%
.... and so on
</code></pre><p>Oh - turns out if you include all the novelty parties there are 132 of them across the UK. We need to sort the array and only print the top X items. Turns out it is quite complicated.</p>
<h3 id="sorting-array">Sorting array</h3>
<p>Standard awk&#39;s array are not sortable. This was a design choice - only associative arrays are supported, so there is no order, hence they can&#39;t be sorted in any meaningful way. <a href="https://www.gnu.org/software/gawk/manual/gawk.html#Arrays">gawk, however, has two array sorting functions</a> - how do they do it? They actually create a new associative array, with all the values from the original but none of they keys; they keys are replaced by new ones, in order. Then you use a for loop (not the standard for in) to read all the array &quot;in order&quot;. This is all well and good if you don&#39;t need the keys, but I do (they are the name of the party). Besides, I am using awk and not gawk.</p>
<p>The best approach is to create a new array with just the keys, sort that array, and then loop through it in order to find out which keys of the original array to read.</p>
<pre><code># kickstarts the sort process
# puts all the sorted keys into a separate array. if i
function homebrew_asort(original, processed) {
  # before we use the array we must be sure it is empty
  empty_array(processed)
  original_length = copy_and_count_array(original, processed)
  qsort(original, processed, 0, original_length)
  return original_length
}

# removes al values
function empty_array(A) {
  for (i in A)
    delete A[i]
}

# awk doesn&#39;t even have an array size function... you also have to roll out your own
function copy_and_count_array(original, processed) {
  for (key in original) {
    # awk doesn&#39;t seem to like array[0] -  so we start from 1
    size++
    processed[size] = key
  }
  return size
}

# Adapted from a script from awk.info
# http://awk.info/?quicksort
function qsort(original, keys, left, right,   i, last) {
  if (left &gt;= right)  return
  swap(keys, left, left + int( (right - left + 1) * rand() ) )
  last = left
  for (i = left+1; i &lt;= right; i++)
    if (original[keys[i]] &lt; original[keys[left]])
      swap(keys, ++last, i)
  swap(keys, left, last)
  qsort(original, keys, left, last-1)
  qsort(original, keys, last+1, right)
}
function swap(A, i, j,   t) {
  t = A[i]; A[i] = A[j]; A[j] = t
}

# same formatting function as before
function print_party_percentage(party_name, party_vote, total_vote) {
  printf &quot;%5s: %4.1f%%\n&quot;, party_name, (100 * party_vote / total_vote)
}

# same main action as before
NR &gt; 1 &amp;&amp; NF  {
  total += $6
  party_totals[$NF] += $6
}

# when all records are processed
END {
  parties_count = homebrew_asort(party_totals, keys)
  for  (i = parties_count; i &gt;= parties_count - 5; i--)
    print_party_percentage(keys[i], party_totals[keys[i]], total)
}
</code></pre><p>And the output</p>
<pre><code>  Con: 36.8%
  Lab: 30.4%
UKIP: 12.6%
  LD:  7.9%
  SNP:  4.7%
Green:  3.8%
</code></pre><h2 id="print-first-or-last-x-characters-of-a-line">Print first or last x characters of a line</h2>
<p>You can easily mimic <code>head -c</code> or <code>tail -c</code> with awk - if you really want to.</p>
<pre><code># head equivalent
$ awk &#39;{print substr($0, 1, 32)}&#39; xxx
$ head -c 32 xxx

# tail equivalent
$ awk &#39;END {print substr($0, length($0) - 30, 32)}&#39; xxx
$ tail -c 32 xxx
</code></pre><p>But with awk you can also skip a few characters into a file</p>
<pre><code># no head or tail equivalent - print characters 32 to 64
$ awk &#39;{print substr($0, 32, 32)}&#39; xxx
</code></pre><h2 id="other-examples">Other examples</h2>
<p>The <a href="http://awk.info/">awk.info</a> website has some <a href="http://awk.info/?OneLiners">one liners</a> with extensive <a href="http://www.catonmat.net/blog/awk-one-liners-explained-part-one/">explanations</a></p>
<p>The <a href="http://www.math.utah.edu/docs/info/gawk_4.html">gawk manual includes some one liners</a> which are compatible with standard awk.</p>
<p>The Unix School: <a href="http://www.theunixschool.com/2012/06/awk-10-examples-to-group-data-in-csv-or.html">10 examples to group data in a CSV or text file</a></p>

      </div>
    </div>
  </article>


<!-- <section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>

  </div>
  -->
  <footer id="footer" class="inner">Copyright &copy; 2016

    Fritz Stelluto

</footer>
<!--
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'goto-fritz';


        // var disqus_developer = 1;
        var disqus_identifier = 'http://gotofritz.net/blog/geekery/backing-up-hard-disk-os-x/';
        var disqus_url = 'http://gotofritz.net/blog/geekery/backing-up-hard-disk-os-x/';
        var disqus_script = 'embed.js';

    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-11254155-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>

-->

</body>
</html>