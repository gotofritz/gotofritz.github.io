<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <title>Ensure an explicit number of expectations within a spec in Jasmine || Fritz Stelluto</title>
  <meta name="author" content="gotofritz">
  <meta name="description" content="QUnit and js-test-driver have ways of specifying how many assertions will be executed in a test case (expect and expectAsserts respectively) but Jasmine doesn&amp;#39;t. But it can still be done - here&amp;#39;s how.">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link href="/assets/favicon.ico" rel="shortcut icon">
  <link rel="icon" href="/assets/favicon.gif" type="image/gif" />
  <link href="/assets/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
</head>

<body ontouchstart="">
  <header id="header" class="inner">
    <nav id="main-nav">
      <div>
        <a href="/">home</a>
        <a href="/blog/">blog</a>
      </div>
    </nav>

    <nav id="sub-nav" class="alignright">
      <form class="search" action="http://google.com/search" method="get">
        <input class="alignright" type="text" name="q" results="0">
        <input type="hidden" name="q" value="site:gotofritz.net">
      </form>
    </nav>
  </header>


<div id="content" class="inner">
  <article class="post">
    <h1 class="title">Ensure an explicit number of expectations within a spec in Jasmine</h1>
    <div>
      <div class="meta">
        <div class="date">
          <time datetime="2014-02-22T23:36:00+01:00" pubdate>2014-02-22</time>
        </div>
        <div class="tags">
          javascript,
          testing,
          jasmine
        </div>
      </div>
      <div class="entry-content">
    <div class="archive">This post is old, and probably obsolete</div>
<p>QUnit and js-test-driver have ways of specifying how many assertions will be executed in a test case (<a href="http://api.qunitjs.com/expect/" title="[new window] expect() | QUnit API Documentation" target="_blank">expect</a> and <a href="https://code.google.com/p/js-test-driver/wiki/TestCase#expectAsserts(count)" title="[new window] TestCase - js-test-driver - Everything you need to know about writing tests. - Remote javascript console - Google Project Hosting" target="_blank">expectAsserts</a> respectively) but Jasmine doesn&#39;t. But it can still be done - here&#39;s how.
<!--more--></p>
<h2 id="why-would-anyone-want-to-count-the-number-of-expectations-in-a-test">Why would anyone want to count the number of expectations in a test</h2>
<p>Usually Jasmine specs are pretty straightforward (here <code>systemUnderTest</code> is defined somewhere else):</p>
<pre><code>it(&quot;does something really simple&quot;, function () {
  var actual = systemUnderTest.methodToTest(arg);
  expect(actual).not.toBe(true);
});
</code></pre><p>There are no branches, and you know Jasmine is going to run through all the expectations, one after the other. But it gets more complicated when loops, or async specs are involved. For example</p>
<pre><code>it(&quot;throws exceptions for all wrong arguments&quot;, function () {
  var methodWrapper = function (arg) { systemUnderTest.methodToTest(arg) };
  var wrongArgs = [
    new Date(),
    Math.random(),
    false,
    null,
    {a: 1, b: 2},
    &quot;a string&quot;,
    [1, 2],
    undefined,
    function () { return 123; }
  ];

  wrongArgs.forEach(function (arg) {
    expect(methodWrapper.bind(null, arg)).toThrow();
  });

});
</code></pre><p>Here there is an array of arguments, each of which should cause the method <code>systemUnderTest.methodToTest</code> to throw an exception. So we loop through the array of arguments, and run an expectation for each of them.
We have to wrap the call to <code>methodToTest</code> in a function, because it&#39;s going to throw an exception - the function <code>methodWrapper</code> is a partial used by <code>.bind</code> to generate such a function. So each iteration of the loop will have a new version of <code>methodWrapper</code>, with <code>arg</code> already plugged in. Then <code>expect</code> can run it, catch the exception, and pass the test.</p>
<p>This is still simple enough, there is only one loop with one statement in it. But you can see how this could easily get out of hand. What if the code was a little more complex, and for some reason the expectations in the loop are not executed? It will look like the test has passed, and you will never know the difference.</p>
<p>The js-test-driver page gives another example, using workers (adapted to Jasmine)</p>
<pre><code>it(&quot;shows what could go wrong&quot;, function () {
  var worker = new Worker();
  var doSomething = {};

  worker.listener = function (work){
    expect(work).toBe(doSomething);
  };
  worker.perform(doSomething);
};
</code></pre><p>If the worker doesn&#39;t call the callback function, then the expectation will not be run, and once again, it will look like the test has passed when it hasn&#39;t.</p>
<h2 id="defining-the-number-of-expected-assertions-in-jasmine">Defining the number of expected assertions in Jasmine</h2>
<p>Jasmine doesn&#39;t have a simple way to tell how many assertions have run, but digging into the code I found where to get the information - in version 1.3 at least: <code>this.env.currentSpec.results_.passedCount</code></p>
<p>Therefore the examples above can be rewritten as</p>
<pre><code>it(&quot;throws exceptions for all wrong arguments&quot;, function () {
  var methodWrapper = function (arg) { systemUnderTest.methodToTest(arg) };
  var wrongArgs = [
    new Date(),
    Math.random(),
    false,
    null,
    {a: 1, b: 2},
    &quot;a string&quot;,
    [1, 2],
    undefined,
    function () { return 123; }
  ];

  wrongArgs.forEach(function (arg) {
    expect(methodWrapper.bind(null, arg)).toThrow();
  });

  expect(this.env.currentSpec.results_.passedCount).toEqual(wrongArgs.length)
});
</code></pre><p>and</p>
<pre><code>it(&quot;shows what could go wrong&quot;, function () {
  var worker = new Worker();
  var doSomething = {};

  worker.listener = function (work){
    expect(work).toBe(doSomething);
  };
  worker.perform(doSomething);
  expect(this.env.currentSpec.results_.passedCount).toBe(1);
};
</code></pre><h2 id="a-note-on-compatibility">A note on compatibility</h2>
<p>This will work, but only in version 1.3 - with the new 2.0 version <a href="https://groups.google.com/forum/#!topic/jasmine-js/IyZt7cPmBWo" title="[new window] Removing .currentSpec from env breaks tests in jasmine 2.0 (since rc5) - Google Groups" target="_blank"><code>currentSpec</code> remains private</a>.</p>
<p>There was a plugin, <a href="https://github.com/dfkaye/jasmine-intercept" title="[new window] dfkaye/jasmine-intercept" target="_blank">jasmine-intercept</a>,  that used to take care of that, but apparently it has now been superseded by <a href="https://github.com/dfkaye/where.js" title="[new window] dfkaye/where.js" target="_blank">where.js</a>. I haven&#39;t had a chance to look into that yet, for now I&#39;ll stick to my quick and dirty workaround.</p>

      </div>
    </div>
  </article>


<!-- <section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>

  </div>
  -->
  <footer id="footer" class="inner">Copyright &copy; 2016

    Fritz Stelluto

</footer>
<!--
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script type="text/javascript">
      var disqus_shortname = 'goto-fritz';


        // var disqus_developer = 1;
        var disqus_identifier = 'http://gotofritz.net/blog/geekery/backing-up-hard-disk-os-x/';
        var disqus_url = 'http://gotofritz.net/blog/geekery/backing-up-hard-disk-os-x/';
        var disqus_script = 'embed.js';

    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>
-->


  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-11254155-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>

</body>
</html>