<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <link href="../favicon.ico" rel="shortcut icon">
  <link rel="icon" href="../favicon.gif" type="image/gif" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-K0CMFHZ2N0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    dataLayer.push('js', new Date());
    dataLayer.push('config', 'G-K0CMFHZ2N0');
  </script>
  <meta http-equiv="content-security-policy" content=""><title>I rebuilt my website with SvelteKit || gotofritz</title><meta name="description" content="Fritz Stelluto has been a developer and engineering manager in the digital industry since the 90s. He lives in Berlin." data-svelte="svelte-ugxg7c">
	<link rel="stylesheet" href="/app_/assets/pages/__layout.svelte-e730745d.css">
	<link rel="stylesheet" href="/app_/assets/_post-6b79a17e.css">
	<link rel="modulepreload" href="/app_/start-e058bdcc.js">
	<link rel="modulepreload" href="/app_/chunks/index-889cf753.js">
	<link rel="modulepreload" href="/app_/pages/__layout.svelte-c3bb9f47.js">
	<link rel="modulepreload" href="/app_/pages/blog/building-blog-with-sveltekit.md-493c373b.js">
	<link rel="modulepreload" href="/app_/chunks/_post-5ef2f492.js">
	<link rel="modulepreload" href="/app_/chunks/Header-15607706.js">
</head>

<body>
  <div class="gradient-container">
    


<main class="panel-container svelte-y2j27e"><div class="content svelte-y2j27e">

<nav class="flat-nav"><div itemscope itemtype="http://schema.org/Person" class="vcard group-of-links"><a href="reordering-audio-files-in-a-fat-usb-stick">previous post</a>
      <a href="/">home</a>
      
    <form class="search" action="https://google.com/search" method="get"><input type="text" id="search-str" name="q" results="0" placeholder="search" aria-label="search">
      <input type="hidden" name="q" value="site:gotofritz.net"></form></div>
</nav>
<article class="content-post svelte-1r1v8if"><section class="intro svelte-1r1v8if"><div class="post-meta"><time datetime="2022-04-22T00:00:00.000Z">2022-04-22</time>
      //
      <div class="tags"><a href="/tags/svelte">svelte</a>, <a href="/tags/gotofritz">gotofritz</a></div></div>
    <h1 class="svelte-1r1v8if">I rebuilt my website with SvelteKit</h1>
    <h2 class="svelte-1r1v8if"><!-- HTML_TAG_START -->https://joshcollinsworth.com/blog/build-static-sveltekit-markdown-blog<!-- HTML_TAG_END --></h2></section>
  <section class="post-content"><h2>Installation</h2>
<pre class="language-bash"><!-- HTML_TAG_START --><code class="language-bash">$ <span class="token function">npm</span> init svelte@next gotofritz
Need to <span class="token function">install</span> the following packages:
  create-svelte@next
Ok to proceed? <span class="token punctuation">(</span>y<span class="token punctuation">)</span> y
<span class="token punctuation">..</span>.

Next steps:
  <span class="token number">1</span>: <span class="token builtin class-name">cd</span> gotofritz
  <span class="token number">2</span>: <span class="token function">npm</span> <span class="token function">install</span> <span class="token punctuation">(</span>or <span class="token function">pnpm</span> install, etc<span class="token punctuation">)</span>
  <span class="token number">3</span>: <span class="token function">git</span> init <span class="token operator">&amp;&amp;</span> <span class="token function">git</span> <span class="token function">add</span> -A <span class="token operator">&amp;&amp;</span> <span class="token function">git</span> commit -m <span class="token string">"Initial commit"</span> <span class="token punctuation">(</span>optional<span class="token punctuation">)</span>
  <span class="token number">4</span>: <span class="token function">npm</span> run dev -- --open

To close the dev server, hit Ctrl-C

Stuck? Visit us at https://svelte.dev/chat

$ <span class="token function">npm</span> <span class="token function">install</span>
gotofritz@0.0.1 prepare
<span class="token punctuation">..</span>.

$ <span class="token function">npm</span> run dev -- --open</code><!-- HTML_TAG_END --></pre>
<p>I hardly had to think - I picked JS over TS (apparently the Svelte MD module doesn’t work too well with TS), eslint and prettier, and bob’s your uncle. Well… <em>mostly</em>. I had to change the prettier settings as they are all wrong - single quotes? tabs??!? who uses tabs in JS? Weird. Well the Svelte devs have volunteered their spare time to give us a wonderful tool, it’s no problem whatsoever to indulge their little quirks. And it could have been worse, at least they use semicolons… Anyway no biggie, I just edit .prettierrc, the prettier config file, and that’s it</p>
<pre class="language-json"><!-- HTML_TAG_START --><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"printWidth"</span><span class="token operator">:</span> <span class="token number">80</span><span class="token punctuation">,</span>
  <span class="token property">"tabWidth"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">"useTabs"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">"semi"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">"singleQuote"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">"trailingComma"</span><span class="token operator">:</span> <span class="token string">"all"</span><span class="token punctuation">,</span>
  <span class="token property">"bracketSpacing"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">"jsxBracketSameLine"</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre>
<h3>Start hacking</h3>
<p>I already have a website built with ancient technology (<a href="https://www.metalsmith.io/" rel="nofollow">Metalsmit</a>, <a href="https://handlebarsjs.com/" rel="nofollow">Handlebars</a>) so my first job is to convert it as is to SvelteKit.</p>
<ul><li><p>Move static assets such as favicons into <code>src/static</code></p></li>
<li><p>Copy the rendered CSS from my old site into <code>src/app.css</code>. Since I will be redesigning it anyway, no point in reorganising all the CSS files to fit SvelteKit’s component structure</p></li>
<li><p>Copy the HTML scaffolding from a variety of Handlebars files into <code>src/app.html</code>. I convert the path variables to <code>%svelte.assets%</code></p></li>
<li><p>Similarly to create-react-app, there are tags such as <code>%svelte.body%</code> and <code>%svelte.head%</code> in your HTML templates for a site’s title and description</p></li>
<li><p>SvelteKit comes with a Header component already wired up. I also had a header component, so it’s pretty much a copy and paste job. This is the only case where I need one of this if/else statements in the template. Easily done with Svelte</p>
<pre class="language-svelte"><!-- HTML_TAG_START --><code class="language-svelte"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">export</span> <span class="token keyword">let</span> isHome <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nav</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>flat-nav<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>
      <span class="token attr-name">itemscope</span>
      <span class="token attr-name">itemtype</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schema.org/Person<span class="token punctuation">"</span></span>
      <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>vcard group-of-links<span class="token punctuation">"</span></span>
    <span class="token punctuation">></span></span>
      <span class="token language-javascript"><span class="token punctuation">&#123;</span>#<span class="token keyword">if</span> isHome<span class="token punctuation">&#125;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mailto:info@gotofritz.net<span class="token punctuation">"</span></span> <span class="token attr-name">itemprop</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>email<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/fritz-stelluto_resume.pdf<span class="token punctuation">"</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>my CV as a PDF<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>my resume<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span>
        <span class="token punctuation">></span></span>
      <span class="token language-javascript"><span class="token punctuation">&#123;</span><span class="token operator">:</span><span class="token keyword">else</span><span class="token punctuation">&#125;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>home<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
      <span class="token language-javascript"><span class="token punctuation">&#123;</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token punctuation">&#125;</span></span>
      ... etc ...</code><!-- HTML_TAG_END --></pre></li>
<li><p>Passing the value of isHome dynamically left me a bit disappointed. It’s not that straigtforward to pass variables up the tree from a page to a layout. My first approach involved using the standard <code>pages</code> store which comes with svelte kit, and using the url property set by the router by default. It works, but it’s neither portable nor elegant.</p>
<pre class="language-svelte"><!-- HTML_TAG_START --><code class="language-svelte"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">&#123;</span> page <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"$app/stores"</span><span class="token punctuation">;</span>
  <span class="token keyword">export</span> <span class="token keyword">let</span> isHome <span class="token operator">=</span> $page<span class="token punctuation">.</span>url<span class="token punctuation">.</span>pathname <span class="token operator">==</span> <span class="token string">"/"</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code><!-- HTML_TAG_END --></pre></li>
<li><p>I want to set variables from inside svelte files, not by hardcoding strings in JS blocks in the layout. I tried with setContext and getContext but no joy there. I know about stores, but it seems a bit of an overkill for a simple variable. I’ll leave it for refactoring later.</p></li>
<li><p>I finally add the content of the homepage to <code>index.svelte</code>. Getting there</p></li></ul>
<h3>Enter mdx</h3>
<p>It’s time to start importing those MD files.</p>
<ul><li><p>First I install mdsvex with <code>npm i -D mdsvex</code></p></li>
<li><p>Then amend the configuration <code>svelte.config.js</code></p>
<pre class="language-js"><!-- HTML_TAG_START --><code class="language-js"><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">extensions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">".svelte"</span><span class="token punctuation">,</span> <span class="token string">".md"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">preprocess</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token function">mdsvex</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      <span class="token literal-property property">extensions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">".md"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
  <span class="token operator">...</span></code><!-- HTML_TAG_END --></pre></li>
<li><p>In my <code>index.svelte</code> I add a JS block to fetch all the metadata for the posts</p>
<pre class="language-svelte"><!-- HTML_TAG_START --><code class="language-svelte"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">context</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">export</span> <span class="token keyword">const</span> prerender <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">load</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> allPostFiles <span class="token operator">=</span> <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span><span class="token function">glob</span><span class="token punctuation">(</span><span class="token string">"../../src-old/blog/**/*.md"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> iterablePostFiles <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>allPostFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> allPosts <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
      iterablePostFiles<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>path<span class="token punctuation">,</span> resolver<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> metadata <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> postPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
          <span class="token literal-property property">archived</span><span class="token operator">:</span> metadata<span class="token punctuation">.</span>archived<span class="token punctuation">,</span>
          <span class="token literal-property property">when</span><span class="token operator">:</span> metadata<span class="token punctuation">.</span>date<span class="token punctuation">,</span>
          <span class="token literal-property property">permalink</span><span class="token operator">:</span> metadata<span class="token punctuation">.</span>permalink<span class="token punctuation">,</span>
          <span class="token literal-property property">published</span><span class="token operator">:</span> metadata<span class="token punctuation">.</span>published<span class="token punctuation">,</span>
          <span class="token literal-property property">tags</span><span class="token operator">:</span>
            metadata<span class="token punctuation">.</span>tags <span class="token operator">&amp;&amp;</span> metadata<span class="token punctuation">.</span>tags<span class="token punctuation">.</span>length
              <span class="token operator">?</span> <span class="token string">"//"</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span>tags<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">" //"</span><span class="token punctuation">)</span>
              <span class="token operator">:</span> <span class="token string">"/ BLOG"</span><span class="token punctuation">,</span>
          <span class="token literal-property property">title</span><span class="token operator">:</span> metadata<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> sortedPosts <span class="token operator">=</span> allPosts<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>when<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// TODO: filter out non-published files when not in dev</span>
    <span class="token comment">// (or maybe simply use _xxxx.md names for them?)</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">posts</span><span class="token operator">:</span> sortedPosts<span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code><!-- HTML_TAG_END --></pre></li>
<li><p>I got the error <code>The request url /Users/gotofritz/Dropbox/src-old/ is outside of Vite serving allow list</code>. That’s because <code>../../src-old/</code> is a symbolic link. Vite resolves it to the actual folder, which I happen to keep in Dropbox. Vite doesn’t like it’s not under te project’s <code>src/</code> but somewhere totally different. Eventually I discover the <code>svelte.config.js</code> amend that makes it work. <code>config.kit.vite</code> is the part of the SvelteKit config where you can add Vite config</p>
<pre class="language-js"><!-- HTML_TAG_START --><code class="language-js"><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">kit</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">vite</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">server</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">fs</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token literal-property property">allow</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"/Users/gotofritz/Dropbox/"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">,</span><span class="token punctuation">,</span> etc</code><!-- HTML_TAG_END --></pre></li>
<li><p>After that is simply a matter of using this data.</p>
<pre class="language-svelte"><!-- HTML_TAG_START --><code class="language-svelte"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token comment">// @ts-nocheck</span>
  <span class="token keyword">import</span> PostSummary <span class="token keyword">from</span> <span class="token string">"$lib/PostSummary.svelte"</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> <span class="token punctuation">&#123;</span> post <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"./todos"</span><span class="token punctuation">;</span>
  <span class="token keyword">export</span> <span class="token keyword">let</span> posts<span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>

<span class="token each"><span class="token punctuation">&#123;</span><span class="token keyword">#each</span> <span class="token language-javascript">posts </span><span class="token keyword">as</span> <span class="token language-javascript">post<span class="token punctuation">&#125;</span></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PostSummary</span> <span class="token language-javascript"><span class="token punctuation">&#123;</span><span class="token operator">...</span>post<span class="token punctuation">&#125;</span></span> <span class="token punctuation">/></span></span>
<span class="token each"><span class="token punctuation">&#123;</span><span class="token keyword">/each</span><span class="token punctuation">&#125;</span></span></code><!-- HTML_TAG_END --></pre></li>
<li><p><code>&lt;PostSummary </code> is a simple component I created for this</p>
<pre class="language-svelte"><!-- HTML_TAG_START --><code class="language-svelte"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">export</span> <span class="token keyword">let</span> tags <span class="token operator">=</span> <span class="token string">"--tags--"</span><span class="token punctuation">;</span>
  <span class="token keyword">export</span> <span class="token keyword">let</span> when <span class="token operator">=</span> <span class="token string">"--when--"</span><span class="token punctuation">;</span>
  <span class="token keyword">export</span> <span class="token keyword">let</span> permalink <span class="token operator">=</span> <span class="token string">"--permalink--"</span><span class="token punctuation">;</span>
  <span class="token keyword">export</span> <span class="token keyword">let</span> title <span class="token operator">=</span> <span class="token string">"--title--"</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> whenHuman <span class="token operator">=</span> when<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>timeline<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>row-label<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>time</span> <span class="token attr-name">datetime=</span><span class="token language-javascript"><span class="token punctuation">&#123;</span>when<span class="token punctuation">&#125;</span></span><span class="token punctuation">></span></span>
      <span class="token language-javascript"><span class="token punctuation">&#123;</span>whenHuman<span class="token punctuation">&#125;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>time</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>row-content<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token language-javascript"><span class="token punctuation">&#123;</span>#<span class="token keyword">if</span> permalink<span class="token punctuation">&#125;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href=</span><span class="token language-javascript"><span class="token punctuation">&#123;</span>permalink<span class="token punctuation">&#125;</span></span><span class="token punctuation">></span></span><span class="token language-javascript"><span class="token punctuation">&#123;</span>title<span class="token punctuation">&#125;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
    <span class="token language-javascript"><span class="token punctuation">&#123;</span><span class="token operator">:</span><span class="token keyword">else</span><span class="token punctuation">&#125;</span></span>
      <span class="token language-javascript"><span class="token punctuation">&#123;</span>title<span class="token punctuation">&#125;</span></span>
    <span class="token language-javascript"><span class="token punctuation">&#123;</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token punctuation">&#125;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>row-label<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token language-javascript"><span class="token punctuation">&#123;</span>tags<span class="token punctuation">&#125;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">></span></span></code><!-- HTML_TAG_END --></pre></li></ul>
<h3>Refactoring: moving file list to an async Svelte Store</h3>
<p>One of SvelteKit’s quirks is that you can have a <code>load</code> function only in a page. In my mind that makes it a bad place for fetching global information. Like, for example, a list of all the files in the site. A <code>store</code> seems the more logical place for that. That gets us into one of the least savoury parts of Svelte: async stores.</p>
<p>Svelte Stores are not designed to be asynchronous. What makes me think that? Their start function needs to return a <code>stop</code> function. But all async functions return a promise. For example, <a href="https://gist.github.com/Theo-Steiner/e7fdbbdde224e5d53c35da26844902bd" rel="nofollow">the code in this gist by Theo Steiner</a> feels like the obvious way to wire up an async store. But if you try it, Svelte fails it with a <code>TypeError: stop is not a function</code> error. That’s because it isn’t. You’d think that <code>async set =&gt; set(await getQuestionData())</code> isn’t returning anything. But it is, it returns a promise. There are workarounds, but they feel like hacks.</p>
<pre class="language-svelte"><!-- HTML_TAG_START --><code class="language-svelte">import <span class="token language-javascript"><span class="token punctuation">&#123;</span> readable <span class="token punctuation">&#125;</span></span> from "svelte/store"
export const questionStore = readable([], async set => set(await getQuestionData()))

async function getQuestionData() <span class="token language-javascript"><span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span>
    <span class="token string">"https://opentdb.com/api.php?amount=10&amp;category=27&amp;difficulty=easy&amp;type=multiple"</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> data<span class="token punctuation">.</span>results
<span class="token punctuation">&#125;</span></span></code><!-- HTML_TAG_END --></pre>
<p>I found <a href="https://github.com/sveltetools/svelte-asyncable" rel="nofollow">svelte-asyncable, an asyncable store</a>. But I am wary of small projects with a single contributor. Their priorities may change and then I’d be stuck with an obsolete library. In the end I went for the least hacky solution: remove the <code>async</code> in favour of old fashioned promise/thens. The page renders, but now the file list loads asynchronously after page load. I have a feeling this may not play well when I’ll get to generating the static site. But I’ll cross that bridge when I get to it.</p>
<pre class="language-js"><!-- HTML_TAG_START --><code class="language-js"><span class="token comment">// stores/sitemap.js</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> readable <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"svelte/store"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">loadFilelist</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> allPostFiles <span class="token operator">=</span> <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span><span class="token function">glob</span><span class="token punctuation">(</span><span class="token string">"../../../src-old/blog/**/2*.md"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> iterablePostFiles <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>allPostFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> allPosts <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
    iterablePostFiles<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span><span class="token punctuation">,</span> resolver<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> metadata <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">archived</span><span class="token operator">:</span> metadata<span class="token punctuation">.</span>archived<span class="token punctuation">,</span>
        <span class="token literal-property property">when</span><span class="token operator">:</span> metadata<span class="token punctuation">.</span>date<span class="token punctuation">,</span>
        <span class="token literal-property property">permalink</span><span class="token operator">:</span> metadata<span class="token punctuation">.</span>permalink<span class="token punctuation">,</span>
        <span class="token literal-property property">published</span><span class="token operator">:</span> metadata<span class="token punctuation">.</span>published<span class="token punctuation">,</span>
        <span class="token literal-property property">tags</span><span class="token operator">:</span>
          metadata<span class="token punctuation">.</span>tags <span class="token operator">&amp;&amp;</span> metadata<span class="token punctuation">.</span>tags<span class="token punctuation">.</span>length
            <span class="token operator">?</span> <span class="token string">"//"</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span>tags<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">" //"</span><span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token string">"// BLOG"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">title</span><span class="token operator">:</span> metadata<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> sortedPosts <span class="token operator">=</span> allPosts<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>when<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// TODO: filter out non-published files when not in dev</span>
  <span class="token comment">// (or maybe simply use _xxxx.md names for them?)</span>

  <span class="token keyword">return</span> sortedPosts<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> filelist <span class="token operator">=</span> <span class="token function">readable</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">set</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">loadFilelist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">set</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre>
<pre class="language-svelte"><!-- HTML_TAG_START --><code class="language-svelte"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token comment">// routes/index.svelte ...</span>
  <span class="token keyword">import</span> PostSummary <span class="token keyword">from</span> <span class="token string">"$lib/PostSummary.svelte"</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> <span class="token punctuation">&#123;</span> filelist <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"$lib/stores/sitemap.js"</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>

... other stuff ...

<span class="token each"><span class="token punctuation">&#123;</span><span class="token keyword">#each</span> <span class="token language-javascript">$filelist </span><span class="token keyword">as</span> <span class="token language-javascript">post<span class="token punctuation">&#125;</span></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PostSummary</span> <span class="token language-javascript"><span class="token punctuation">&#123;</span><span class="token operator">...</span>post<span class="token punctuation">&#125;</span></span> <span class="token punctuation">/></span></span>
<span class="token each"><span class="token punctuation">&#123;</span><span class="token keyword">/each</span><span class="token punctuation">&#125;</span></span></code><!-- HTML_TAG_END --></pre>
<h3>Adding MD blog posts to SvelteKit</h3>
<p>I wanted to keep my old blog posts where they are, in Dropbox. That way I could decouple them from the site implementation. Creating a symbolic link to them with</p>
<pre class="language-bash"><!-- HTML_TAG_START --><code class="language-bash">$ <span class="token function">ln</span> -s ~/Dropbox/my_folder routes/blog</code><!-- HTML_TAG_END --></pre>
<p>wasn’t possible. The config trick I used for generating the index page doesn’t work with routes. Additionally I couldn’t find a way to rename routes dynamically. The posts file names follow the Jenkins convention, <code>yyyy-mm-dd-the-post-slug.md</code>. I couldn’t make them accessible as <code>the-post-slug</code>. Quite simply, SvelteKit can be used as a static site generator. But at heart, it isn’t one. I bit the bullet and copied the md files files inside the <code>routes/blog/</code> folder. Then removed the date from the filename. It worked without a glitch.</p>
<h4>Adding excerpts with mdsvex</h4>
<p>My markdown sourcefiles had an excerpt section in the body. That was separated from the main body with an HTML comment. They were originally Wordpress posts, that’s the reason for that. And once I set up my blog engine that way, I applied the same principle to all posts.</p>
<pre class="language-html"><!-- HTML_TAG_START --><code class="language-html">---
some: frontmatter
title: My Post
---

Here is <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">></span></span>the excerpt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">></span></span>. Just some HTML
<span class="token comment">&lt;!--more--></span>
Now comes the rest of the post. Also HTML</code><!-- HTML_TAG_END --></pre>
<p><code>mdsvex</code> doesn’t provide a way to handle that. You can apply a chain of <a href="https://remark.js.org/" rel="nofollow">remark</a> plugins to the markdown source, and of <a href="https://github.com/rehypejs/rehype/blob/main/doc/plugins.md" rel="nofollow">rehype</a> plugins to the generated HTML. But then <code>mdsvex</code> gets whatever comes out from the other end as a Svelte component. You can’t fiddle with it in a template (at least, not as far as I could make out).</p>
<p>There is, actually, <a href="https://www.npmjs.com/package/remark-excerpt" rel="nofollow">a remark plugin for extracting a Wordpress style excerpts</a>. It works quite well. But it keeps the excerpt and throws away the body. Mdsvex is not sophisticated enough to “split” the markdown data into a body <em>and</em> an excerpt and handle both in parallel. That is actually very similar to my old metalsmith engine, or to gulp, from the same era… I hoped it would be more capable, but Sveltekit is not a pure <abbr title="Static Site Generator">SSG</abbr>. In the end rather than fighting it I preferred writing a simple script to batch-process all the posts I have. I moved any “special” information which needs special treatment to the frontmatter. The body is just the page content, nothing meta in it. It makes more sense that way.</p>
<p>There is another way to handle the whole thing. One which should allow me to move the markdown files back to my Dropbox folder. But I will attempt it in the next version.</p>
<h3>Tags</h3></section>
</article></div>
  <footer class="svelte-tqiyh5"><div class="content svelte-tqiyh5"><nav class="flat-nav svelte-tqiyh5"><div itemscope itemtype="http://schema.org/Person" class="vcard group-of-links svelte-tqiyh5"><a href="https://github.com/gotofritz" class="svelte-tqiyh5">github</a><a href="https://twitter.com/gotofritz" class="svelte-tqiyh5">twitter</a><a href="https://www.linkedin.com/in/gotofritz" class="svelte-tqiyh5">linkedin</a><a href="/feed.xml" class="svelte-tqiyh5">rss</a></div></nav></div>
  
  <div class="content svelte-tqiyh5">All content under <a href="http://creativecommons.org/licenses/by-nc-sa/2.0/de/" class="svelte-tqiyh5">creative commons</a>
    and code under <a href="http://mit-license.org/" class="svelte-tqiyh5">MIT license</a>.
  </div>
</footer>
</main>


		<script type="module" data-hydrate="wvz5jy">
		import { start } from "/app_/start-e058bdcc.js";
		start({
			target: document.querySelector('[data-hydrate="wvz5jy"]').parentNode,
			paths: {"base":"","assets":""},
			session: {},
			route: true,
			spa: false,
			trailing_slash: "never",
			hydrate: {
				status: 200,
				error: null,
				nodes: [
					import("/app_/pages/__layout.svelte-c3bb9f47.js"),
						import("/app_/pages/blog/building-blog-with-sveltekit.md-493c373b.js")
				],
				params: {},
				routeId: "blog/building-blog-with-sveltekit"
			}
		});
	</script>
  </div>
</body>

</html>